<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý nhà hàng - Foodiee</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Reset */
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* === Sidebar (New Style 2) === */
        .sidebar {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            color: white;
            width: 220px;
            transition: width 0.3s ease;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            height: 100vh;
            position: fixed;
            z-index: 100;
        }

        .sidebar.closed {
            width: 60px;
        }

        .sidebar .toggle-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            padding: 15px 20px;
            cursor: pointer;
            text-align: left;
            width: 100%;
        }

        .nav-menu {
            flex-grow: 1;
        }

        .nav-menu ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .nav-menu ul li a {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            color: white;
            text-decoration: none;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .nav-menu ul li a i {
            margin-right: 15px;
            min-width: 25px;
            font-size: 18px;
        }

        .nav-menu ul li a:hover {
            background-color: rgba(255,255,255,0.2);
        }

        .nav-menu ul li a.active {
            background-color: rgba(255,255,255,0.25);
        }

        .sidebar.closed .link-text {
            display: none;
        }

        /* === Main content === */
        main {
            flex: 1;
            margin-left: 220px;
            padding: 20px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
            
        }

        .content-wrapper {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e6ed;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .header p {
            color: var(--gray);
            font-size: 16px;
        }

        .current-time {
            background: #fff;
            padding: 10px 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            font-size: 15px;
            color: #555;
        }


        /* === Thống kê === */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.08);
        }

        .stat-card h3 {
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 15px;
            color: #2c3e50;
            font-weight: 600;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 15px;
            color: #ff416c;
        }

        .stat-card .info {
            font-size: 14px;
            color: #777;
            border-top: 1px solid #eee;
            padding-top: 12px;
            display: flex;
            justify-content: space-between;
        }

        .stat-card .info span {
            display: block;
        }

        /* === Quản lý khu vực & bàn === */
        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 30px 0 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e6ed;
        }

        .management-header h2 {
            font-size: 22px;
            color: #2c3e50;
            margin: 0;
        }

        .btn {
            padding: 10px 18px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .btn i {
            margin-right: 8px;
        }

        .btn-primary {
            background: #ff416c;
            color: white;
        }

        .btn-primary:hover {
            background: #e03a5f;
            box-shadow: 0 4px 8px rgba(255, 65, 108, 0.3);
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        /* Khu vực */
        .areas-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .area-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 350px;
            overflow: hidden;
        }

        .area-header {
            padding: 15px 20px;
            background: #ff416c;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .area-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .area-actions {
            display: flex;
            gap: 10px;
        }

        .area-actions button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .area-actions button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .tables-container {
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            min-height: 150px;
        }

        .no-data, .no-tables {
            text-align: center;
            padding: 30px 0;
            color: #777;
            font-style: italic;
            grid-column: 1 / -1;
        }

        /* Bàn */
        .table-card {
            background: #f8f9fa;
            border-radius: 8px;
            height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid #e0e6ed;
        }

        .table-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: #ff416c;
        }

        .table-card.available {
            background: #e8f5e9;
            border-color: #66bb6a;
        }

        .table-card.occupied {
            background: #ffebee;
            border-color: #ef9a9a;
        }

        .table-card.reserved {
            background: #fff8e1;
            border-color: #ffd54f;
        }

        .table-card.disabled {
            background: #e0e0e0;
            border-color: #bdbdbd;
            opacity: 0.6;
        }

        .table-number {
            font-weight: bold;
            font-size: 18px;
            color: #2c3e50;
        }

        .capacity {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }

        .guests {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .table-status {
            position: absolute;
            bottom: 5px;
            left: 5px;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }

        .available .table-status {
            background: #66bb6a;
            color: white;
        }

        .occupied .table-status {
            background: #ef9a9a;
            color: white;
        }

        .reserved .table-status {
            background: #ffd54f;
            color: #333;
        }

        .disabled .table-status {
            background: #9e9e9e;
            color: white;
        }

        .table-actions {
            position: absolute;
            bottom: 5px;
            right: 5px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .table-card:hover .table-actions {
            opacity: 1;
        }

        .table-actions button {
            width: 26px;
            height: 26px;
            border-radius: 50%;
            border: none;
            background: #f1f2f6;
            color: #777;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .table-actions button:hover {
            background: #ff416c;
            color: white;
        }

        .add-table-btn {
            background: transparent;
            border: 2px dashed #bdc3c7;
            color: #777;
            flex-direction: column;
            cursor: pointer;
        }

        .add-table-btn:hover {
            border-color: #ff416c;
            color: #ff416c;
            background: rgba(255, 65, 108, 0.05);
        }

        .add-table-btn i {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* === Quản lý công nợ === */
        .debt-management {
            margin-top: 40px;
            border-top: 1px solid #e0e6ed;
            padding-top: 30px;
        }

        .debt-summary {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .debt-summary .total-debt {
            font-size: 24px;
            font-weight: 700;
            color: #e74c3c;
        }

        .debt-list {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .debt-list-header {
            display: grid;
            grid-template-columns: 3fr 2fr 2fr 2fr 2fr 1fr;
            padding: 15px 20px;
            background: #f8f9fa;
            font-weight: 600;
            border-bottom: 1px solid #e0e6ed;
        }

        .debt-item {
            display: grid;
            grid-template-columns: 3fr 2fr 2fr 2fr 2fr 1fr;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
        }

        .debt-item:hover {
            background: #f9f9f9;
        }

        .debt-item:last-child {
            border-bottom: none;
        }

        .debt-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }

        .debt-status.paid {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .debt-status.unpaid {
            background: #ffebee;
            color: #c62828;
        }

        .debt-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .debt-actions button {
            background: none;
            border: none;
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .debt-actions button:hover {
            background: #f1f2f6;
        }

        .debt-actions .edit-btn {
            color: #3498db;
        }

        .debt-actions .delete-btn {
            color: #e74c3c;
        }

        /* === Modal === */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px;
            background: #ff416c;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            opacity: 0.8;
        }

        .close-btn:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 15px;
            transition: border 0.3s;
        }

        .form-control:focus {
            border-color: #ff416c;
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 65, 108, 0.2);
        }

        .modal-footer {
            padding: 15px 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-footer .btn {
            min-width: 100px;
        }

        .error-message {
            color: #e74c3c;
            font-size: 13px;
            margin-top: 5px;
            display: none;
        }

        .firebase-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid #ff416c;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 992px) {
            .stat-card .value {
                font-size: 28px;
            }
            
            .areas-container {
                justify-content: center;
            }
        }
        
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            
            .sidebar .link-text {
                display: none;
            }
            
            main, footer {
                margin-left: 60px !important;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .current-time {
                align-self: stretch;
            }

            .debt-list-header,
            .debt-item {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }
        
        @media (max-width: 576px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .management-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .management-header .btn {
                align-self: stretch;
                justify-content: center;
            }
            
            .modal-content {
                margin: 0 15px;
            }

            .debt-summary {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div id="firebase-loading" class="firebase-loading">
        <div class="spinner"></div>
        <p>Đang kết nối với hệ thống...</p>
    </div>
    
    <div id="app" style="display: none;">
        <div id="sidebar" class="sidebar">
            <button id="toggleSidebar" class="toggle-btn">
                <i class="fas fa-bars"></i>
            </button>
            <nav class="nav-menu">
                <ul>
                    <li><a href="overview.html"><i class="fas fa-chart-line"></i><span class="link-text">Tổng quan</span></a></li>
                    <li><a href="staff.html"><i class="fas fa-users"></i><span class="link-text">Quản lý nhân viên</span></a></li>
                    <li><a href="restaurant.html" class="active"><i class="fas fa-utensils"></i><span class="link-text">Quản lý nhà hàng</span></a></li>
                    <li><a href="warehouse.html"><i class="fas fa-warehouse"></i><span class="link-text">Quản lý kho</span></a></li>
                    <li><a href="account.html"><i class="fas fa-user-cog"></i><span class="link-text">Tài khoản</span></a></li>
                </ul>
            </nav>
        </div>

        <main>
            <div class="content-wrapper">
                <div class="header">
                    <div>
                        <h1>Quản lý nhà hàng</h1>
                        <p>Thông tin nhà hàng và chi nhánh</p>
                    </div>
                    <div class="current-time">
                        <i class="far fa-clock"></i> <span id="currentDateTime">lúc 08:27 Thứ Sáu, 20 tháng 6, 2025</span>
                    </div>
                </div>

                <div class="stats-container">
                    <div class="stat-card">
                        <h3>Số khách trong quán</h3>
                        <div class="value" id="customers-in-restaurant">0</div>
                        <div class="info">
                            <span>Đã phục vụ hôm nay: <span id="customers-served">0</span></span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <h3>Nhân viên đang làm</h3>
                        <div class="value" id="staff-working">0</div>
                        <div class="info">
                            <span>Phục vụ: <span id="staff-serving">0</span> | Bếp: <span id="staff-cooking">0</span></span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <h3>Doanh thu hôm nay</h3>
                        <div class="value" id="revenue-today">0₫</div>
                        <div class="info">
                            <span>Hóa đơn: <span id="invoices-count">0</span></span>
                        </div>
                    </div>

                    <div class="stat-card">
                        <h3>Tình trạng bàn</h3>
                        <div class="value" id="tables-status">0/0</div>
                        <div class="info">
                            <span>Trống: <span id="available-tables">0</span></span>
                            <span>Sử dụng: <span id="occupied-tables">0</span></span>
                        </div>
                    </div>
                </div>

                <div class="management-header">
                    <h2>Quản lý khu vực & bàn</h2>
                    <button id="btnAddArea" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Thêm khu vực
                    </button>
                </div>

                <div class="areas-container" id="areasContainer">
                    <!-- Khu vực và bàn sẽ được thêm vào bằng JS -->
                    <div class="no-data">Chưa có khu vực nào. Hãy thêm khu vực đầu tiên!</div>
                </div>

                <!-- Phần quản lý công nợ mới -->
                <div class="debt-management">
                    <div class="management-header">
                        <h2>Quản lý công nợ</h2>
                        <button id="btnAddDebt" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Thêm công nợ
                        </button>
                    </div>

                    <div class="debt-summary">
                        <div>
                            <h3>Tổng công nợ chưa thanh toán</h3>
                            <div class="total-debt" id="total-debt">0₫</div>
                        </div>
                        <div>
                            <p><strong>Chưa thanh toán:</strong> <span id="unpaid-debt-count">0</span> công nợ</p>
                            <p><strong>Đã thanh toán:</strong> <span id="paid-debt-count">0</span> công nợ</p>
                        </div>
                    </div>

                    <div class="debt-list">
                        <div class="debt-list-header">
                            <div>Tên công nợ</div>
                            <div>Loại công nợ</div>
                            <div>Số tiền</div>
                            <div>Ngày tạo</div>
                            <div>Trạng thái</div>
                            <div>Thao tác</div>
                        </div>
                        <div id="debtsContainer">
                            <div class="no-data">Chưa có công nợ nào</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Footer đã được xóa theo yêu cầu -->
    </div>

    <!-- Modal khu vực -->
    <div id="areaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalAreaTitle">Thêm khu vực mới</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="areaName">Tên khu vực *</label>
                    <input type="text" id="areaName" class="form-control" placeholder="Nhập tên khu vực">
                    <div id="areaNameError" class="error-message">Tên khu vực đã tồn tại</div>
                </div>
                <div class="form-group">
                    <label for="areaDescription">Mô tả</label>
                    <textarea id="areaDescription" class="form-control" placeholder="Mô tả khu vực" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelArea" class="btn">Hủy bỏ</button>
                <button id="btnSaveArea" class="btn btn-primary">Lưu khu vực</button>
            </div>
        </div>
    </div>
    
    <!-- Modal bàn -->
    <div id="tableModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTableTitle">Thêm bàn mới</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="tableNumber">Số bàn *</label>
                    <input type="text" id="tableNumber" class="form-control" placeholder="Nhập số bàn">
                    <div id="tableNumberError" class="error-message">Số bàn đã tồn tại trong khu vực này</div>
                </div>
                <div class="form-group">
                    <label for="tableCapacity">Sức chứa *</label>
                    <input type="number" id="tableCapacity" class="form-control" min="2" max="20" value="4">
                </div>
                <div class="form-group">
                    <label for="tableStatus">Trạng thái *</label>
                    <select id="tableStatus" class="form-control">
                        <option value="available">Trống</option>
                        <option value="occupied">Đang sử dụng</option>
                        <option value="reserved">Đã đặt trước</option>
                        <option value="disabled">Vô hiệu hóa</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelTable" class="btn">Hủy bỏ</button>
                <button id="btnSaveTable" class="btn btn-primary">Lưu bàn</button>
            </div>
        </div>
    </div>
    
    <!-- Modal công nợ -->
    <div id="debtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalDebtTitle">Thêm công nợ mới</h2>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="debtName">Tên công nợ *</label>
                    <input type="text" id="debtName" class="form-control" placeholder="Nhập tên công nợ">
                </div>
                <div class="form-group">
                    <label for="debtType">Loại công nợ *</label>
                    <select id="debtType" class="form-control">
                        <option value="salary">Lương nhân viên</option>
                        <option value="material">Mua nguyên vật liệu</option>
                        <option value="other">Khác</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="debtAmount">Số tiền *</label>
                    <input type="number" id="debtAmount" class="form-control" min="0" placeholder="Nhập số tiền">
                </div>
                <div class="form-group">
                    <label for="debtDate">Ngày tạo *</label>
                    <input type="date" id="debtDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="debtStatus">Trạng thái *</label>
                    <select id="debtStatus" class="form-control">
                        <option value="unpaid">Chưa thanh toán</option>
                        <option value="paid">Đã thanh toán</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnCancelDebt" class="btn">Hủy bỏ</button>
                <button id="btnSaveDebt" class="btn btn-primary">Lưu công nợ</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDV06m47eD90e8n3vTd6B9NmKsEOUz_r_E",
            authDomain: "foodiee-506f6.firebaseapp.com",
            projectId: "foodiee-506f6",
            storageBucket: "foodiee-506f6.appspot.com",
            messagingSenderId: "628837902932",
            appId: "1:628837902932:web:fcdfcfca84ad76e700dbc1",
            measurementId: "G-3ZNLCPWM94"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        
        // Firebase references
        const statisticsRef = db.ref('statistics');
        const areasRef = db.ref('areas');
        const debtsRef = db.ref('debts'); // Tham chiếu mới cho công nợ
        
        // DOM elements
        const appContainer = document.getElementById('app');
        const loadingContainer = document.getElementById('firebase-loading');
        const areasContainer = document.getElementById('areasContainer');
        const customersInRestaurantEl = document.getElementById('customers-in-restaurant');
        const customersServedEl = document.getElementById('customers-served');
        const staffWorkingEl = document.getElementById('staff-working');
        const staffServingEl = document.getElementById('staff-serving');
        const staffCookingEl = document.getElementById('staff-cooking');
        const revenueTodayEl = document.getElementById('revenue-today');
        const invoicesCountEl = document.getElementById('invoices-count');
        const tablesStatusEl = document.getElementById('tables-status');
        const availableTablesEl = document.getElementById('available-tables');
        const occupiedTablesEl = document.getElementById('occupied-tables');
        const currentDateTime = document.getElementById('currentDateTime');
        
        // Công nợ elements
        const totalDebtEl = document.getElementById('total-debt');
        const unpaidDebtCountEl = document.getElementById('unpaid-debt-count');
        const paidDebtCountEl = document.getElementById('paid-debt-count');
        const debtsContainer = document.getElementById('debtsContainer');
        const btnAddDebt = document.getElementById('btnAddDebt');
        
        // Modal elements
        const areaModal = document.getElementById('areaModal');
        const tableModal = document.getElementById('tableModal');
        const debtModal = document.getElementById('debtModal');
        const modalAreaTitle = document.getElementById('modalAreaTitle');
        const modalTableTitle = document.getElementById('modalTableTitle');
        const modalDebtTitle = document.getElementById('modalDebtTitle');
        const areaNameInput = document.getElementById('areaName');
        const areaDescInput = document.getElementById('areaDescription');
        const tableNumberInput = document.getElementById('tableNumber');
        const tableCapacityInput = document.getElementById('tableCapacity');
        const tableStatusInput = document.getElementById('tableStatus');
        const debtNameInput = document.getElementById('debtName');
        const debtTypeInput = document.getElementById('debtType');
        const debtAmountInput = document.getElementById('debtAmount');
        const debtDateInput = document.getElementById('debtDate');
        const debtStatusInput = document.getElementById('debtStatus');
        const btnAddArea = document.getElementById('btnAddArea');
        const btnSaveArea = document.getElementById('btnSaveArea');
        const btnCancelArea = document.getElementById('btnCancelArea');
        const btnSaveTable = document.getElementById('btnSaveTable');
        const btnCancelTable = document.getElementById('btnCancelTable');
        const btnSaveDebt = document.getElementById('btnSaveDebt');
        const btnCancelDebt = document.getElementById('btnCancelDebt');
        const areaNameError = document.getElementById('areaNameError');
        const tableNumberError = document.getElementById('tableNumberError');
        
        // State variables
        let currentAreaId = null;
        let currentTableId = null;
        let currentDebtId = null;
        let isEditingArea = false;
        let isEditingTable = false;
        let isEditingDebt = false;
        let areaNames = [];
        let tableNumbers = [];
        let currentAreas = {}; // Lưu trữ dữ liệu khu vực hiện tại
        let currentDebts = {}; // Lưu trữ dữ liệu công nợ hiện tại
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Setup sidebar toggle
            const toggleBtn = document.getElementById('toggleSidebar');
            const sidebar = document.getElementById('sidebar');
            
            toggleBtn.addEventListener('click', () => {
                sidebar.classList.toggle('closed');
                const isClosed = sidebar.classList.contains('closed');
                document.body.classList.toggle('sidebar-closed', isClosed);
            });
            
            // Check authentication
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    setupFirebaseListeners();
                    updateDateTime();
                    setInterval(updateDateTime, 60000);
                    setupEventListeners();
                } else {
                    // No user is signed in
                    window.location.href = "login.html";
                }
            });
        });
        
        // Setup Firebase listeners
        function setupFirebaseListeners() {
            // Listen for statistics changes
            statisticsRef.on('value', (snapshot) => {
                const stats = snapshot.val();
                if (stats) {
                    updateStatistics(stats);
                }
            });
            
            // Listen for areas changes
            areasRef.on('value', (snapshot) => {
                const areasData = snapshot.val();
                currentAreas = areasData || {};
                
                if (areasData) {
                    renderAreas(areasData);
                } else {
                    areasContainer.innerHTML = '<div class="no-data">Chưa có khu vực nào. Hãy thêm khu vực đầu tiên!</div>';
                }
            });
            
            // Listen for debts changes
            debtsRef.on('value', (snapshot) => {
                const debtsData = snapshot.val();
                currentDebts = debtsData || {};
                
                if (debtsData) {
                    renderDebts(debtsData);
                    calculateTotalDebt(debtsData);
                } else {
                    debtsContainer.innerHTML = '<div class="no-data">Chưa có công nợ nào</div>';
                    totalDebtEl.textContent = formatCurrency(0);
                    unpaidDebtCountEl.textContent = '0';
                    paidDebtCountEl.textContent = '0';
                }
                
                // Hide loading and show app
                loadingContainer.style.display = 'none';
                appContainer.style.display = 'block';
            });
        }
        
        // Update statistics
        function updateStatistics(stats) {
            customersInRestaurantEl.textContent = stats.customersInRestaurant || 0;
            customersServedEl.textContent = stats.customersServed || 0;
            staffWorkingEl.textContent = stats.staffWorking || 0;
            staffServingEl.textContent = stats.staffServing || 0;
            staffCookingEl.textContent = stats.staffCooking || 0;
            revenueTodayEl.textContent = formatCurrency(stats.revenueToday || 0);
            invoicesCountEl.textContent = stats.invoices || 0;
            
            // Calculate table status
            const occupied = stats.occupiedTables || 0;
            const reserved = stats.reservedTables || 0;
            const available = stats.availableTables || 0;
            const disabled = stats.disabledTables || 0;
            const total = occupied + reserved + available + disabled;
            
            tablesStatusEl.textContent = `${occupied + reserved}/${total}`;
            availableTablesEl.textContent = available;
            occupiedTablesEl.textContent = occupied + reserved;
        }
        
        // Render areas and tables
        function renderAreas(areasData) {
            areasContainer.innerHTML = '';
            
            // Reset area names for validation
            areaNames = [];
            
            if (!areasData || Object.keys(areasData).length === 0) {
                areasContainer.innerHTML = '<div class="no-data">Chưa có khu vực nào. Hãy thêm khu vực đầu tiên!</div>';
                return;
            }
            
            Object.keys(areasData).forEach(areaId => {
                const area = areasData[areaId];
                areaNames.push(area.name.toLowerCase());
                
                const areaCard = document.createElement('div');
                areaCard.className = 'area-card';
                areaCard.innerHTML = `
                    <div class="area-header">
                        <h3>${area.name}</h3>
                        <div class="area-actions">
                            <button class="edit-area" data-id="${areaId}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-area" data-id="${areaId}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="tables-container">
                        ${renderTables(area.tables, areaId)}
                        <div class="table-card add-table-btn" data-area="${areaId}">
                            <i class="fas fa-plus"></i>
                            <span>Thêm bàn</span>
                        </div>
                    </div>
                `;
                areasContainer.appendChild(areaCard);
            });
            
            // Add event listeners to action buttons
            document.querySelectorAll('.edit-area').forEach(btn => {
                btn.addEventListener('click', () => editArea(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-area').forEach(btn => {
                btn.addEventListener('click', () => deleteArea(btn.dataset.id));
            });
            
            document.querySelectorAll('.edit-table').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    editTable(btn.dataset.area, btn.dataset.id);
                });
            });
            
            document.querySelectorAll('.delete-table').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTable(btn.dataset.area, btn.dataset.id);
                });
            });
            
            document.querySelectorAll('.table-card:not(.add-table-btn)').forEach(card => {
                card.addEventListener('click', () => {
                    const areaId = card.dataset.area;
                    const tableId = card.dataset.id;
                    // Implement table selection functionality
                    alert(`Bàn được chọn: ${tableId} trong khu vực ${areaId}`);
                });
            });
            
            document.querySelectorAll('.add-table-btn').forEach(btn => {
                btn.addEventListener('click', () => addTable(btn.dataset.area));
            });
        }
        
        // Render tables for an area
        function renderTables(tablesData, areaId) {
            if (!tablesData || Object.keys(tablesData).length === 0) {
                return '<div class="no-tables">Chưa có bàn nào trong khu vực này</div>';
            }
            
            // Reset table numbers for validation
            tableNumbers = [];
            
            return Object.keys(tablesData).map(tableId => {
                const table = tablesData[tableId];
                tableNumbers.push(table.number.toLowerCase());
                
                const statusText = 
                    table.status === 'occupied' ? 'Sử dụng' : 
                    table.status === 'reserved' ? 'Đặt trước' : 
                    table.status === 'disabled' ? 'Vô hiệu' : 'Trống';
                
                const guestBadge = table.guests > 0 ? `<div class="guests">${table.guests}</div>` : '';
                
                return `
                    <div class="table-card ${table.status}" 
                         data-area="${areaId}" 
                         data-id="${tableId}">
                        ${guestBadge}
                        <div class="table-number">${table.number}</div>
                        <div class="capacity">${table.capacity} chỗ</div>
                        <div class="table-status">${statusText}</div>
                        <div class="table-actions">
                            <button class="edit-table" 
                                    data-area="${areaId}" 
                                    data-id="${tableId}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="delete-table" 
                                    data-area="${areaId}" 
                                    data-id="${tableId}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Render debts
        function renderDebts(debtsData) {
            debtsContainer.innerHTML = '';
            
            if (!debtsData || Object.keys(debtsData).length === 0) {
                debtsContainer.innerHTML = '<div class="no-data">Chưa có công nợ nào</div>';
                return;
            }
            
            Object.keys(debtsData).forEach(debtId => {
                const debt = debtsData[debtId];
                const debtDate = new Date(debt.createdAt);
                const formattedDate = debtDate.toLocaleDateString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
                
                // Map debt type to readable text
                let typeText = 'Khác';
                if (debt.type === 'salary') typeText = 'Lương nhân viên';
                if (debt.type === 'material') typeText = 'Mua nguyên vật liệu';
                
                // Status styling
                const statusClass = debt.status === 'paid' ? 'paid' : 'unpaid';
                const statusText = debt.status === 'paid' ? 'Đã thanh toán' : 'Chưa thanh toán';
                
                const debtItem = document.createElement('div');
                debtItem.className = 'debt-item';
                debtItem.innerHTML = `
                    <div>${debt.name}</div>
                    <div>${typeText}</div>
                    <div>${formatCurrency(debt.amount)}</div>
                    <div>${formattedDate}</div>
                    <div><span class="debt-status ${statusClass}">${statusText}</span></div>
                    <div class="debt-actions">
                        <button class="edit-btn" data-id="${debtId}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="delete-btn" data-id="${debtId}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                debtsContainer.appendChild(debtItem);
            });
            
            // Add event listeners to debt action buttons
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', () => editDebt(btn.dataset.id));
            });
            
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteDebt(btn.dataset.id));
            });
        }
        
        // Calculate total debt
        function calculateTotalDebt(debtsData) {
            let totalDebt = 0;
            let unpaidCount = 0;
            let paidCount = 0;
            
            Object.keys(debtsData).forEach(debtId => {
                const debt = debtsData[debtId];
                if (debt.status === 'unpaid') {
                    totalDebt += debt.amount;
                    unpaidCount++;
                } else {
                    paidCount++;
                }
            });
            
            totalDebtEl.textContent = formatCurrency(totalDebt);
            unpaidDebtCountEl.textContent = unpaidCount;
            paidDebtCountEl.textContent = paidCount;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Area modal
            btnAddArea.addEventListener('click', () => {
                isEditingArea = false;
                modalAreaTitle.textContent = "Thêm khu vực mới";
                areaNameInput.value = "";
                areaDescInput.value = "";
                areaNameError.style.display = 'none';
                areaModal.style.display = "flex";
            });
            
            btnSaveArea.addEventListener('click', saveArea);
            btnCancelArea.addEventListener('click', () => areaModal.style.display = "none");
            
            // Table modal
            btnSaveTable.addEventListener('click', saveTable);
            btnCancelTable.addEventListener('click', () => tableModal.style.display = "none");
            
            // Debt modal
            btnAddDebt.addEventListener('click', () => {
                isEditingDebt = false;
                modalDebtTitle.textContent = "Thêm công nợ mới";
                debtNameInput.value = "";
                debtTypeInput.value = "salary";
                debtAmountInput.value = "";
                debtDateInput.valueAsDate = new Date();
                debtStatusInput.value = "unpaid";
                debtModal.style.display = "flex";
            });
            
            btnSaveDebt.addEventListener('click', saveDebt);
            btnCancelDebt.addEventListener('click', () => debtModal.style.display = "none");
            
            // Close modals when clicking outside
            window.addEventListener('click', (e) => {
                if (e.target === areaModal) areaModal.style.display = "none";
                if (e.target === tableModal) tableModal.style.display = "none";
                if (e.target === debtModal) debtModal.style.display = "none";
            });
            
            // Close buttons
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    areaModal.style.display = "none";
                    tableModal.style.display = "none";
                    debtModal.style.display = "none";
                });
            });
        }
        
        // Edit area
        function editArea(areaId) {
            areasRef.child(areaId).once('value', (snapshot) => {
                const area = snapshot.val();
                if (area) {
                    isEditingArea = true;
                    currentAreaId = areaId;
                    modalAreaTitle.textContent = "Chỉnh sửa khu vực";
                    areaNameInput.value = area.name;
                    areaDescInput.value = area.description || '';
                    areaNameError.style.display = 'none';
                    areaModal.style.display = "flex";
                }
            });
        }
        
        // Delete area
        function deleteArea(areaId) {
            if (confirm("Bạn có chắc chắn muốn xóa khu vực này? Tất cả các bàn trong khu vực sẽ bị xóa.")) {
                areasRef.child(areaId).remove()
                    .then(() => {
                        console.log("Khu vực đã được xóa");
                    })
                    .catch(error => {
                        console.error("Lỗi khi xóa khu vực: ", error);
                        alert("Đã xảy ra lỗi khi xóa khu vực");
                    });
            }
        }
        
        // Save area (add or edit)
        function saveArea() {
            const name = areaNameInput.value.trim();
            const desc = areaDescInput.value.trim();
            
            if (!name) {
                alert("Vui lòng nhập tên khu vực");
                return;
            }
            
            // Check for duplicate area name
            const normalizedName = name.toLowerCase();
            if (areaNames.includes(normalizedName)) {
                // Nếu đang chỉnh sửa, kiểm tra xem tên mới có khác tên cũ không
                if (isEditingArea) {
                    const oldArea = currentAreas[currentAreaId];
                    if (oldArea && oldArea.name.toLowerCase() !== normalizedName) {
                        areaNameError.style.display = 'block';
                        return;
                    }
                } else {
                    areaNameError.style.display = 'block';
                    return;
                }
            }
            
            areaNameError.style.display = 'none';
            
            const areaData = {
                name: name,
                description: desc
            };
            
            if (isEditingArea) {
                // Update existing area
                areasRef.child(currentAreaId).update(areaData)
                    .then(() => {
                        areaModal.style.display = "none";
                    })
                    .catch(error => {
                        console.error("Lỗi khi cập nhật khu vực: ", error);
                        alert("Đã xảy ra lỗi khi cập nhật khu vực");
                    });
            } else {
                // Add new area
                areasRef.push(areaData)
                    .then(() => {
                        areaModal.style.display = "none";
                    })
                    .catch(error => {
                        console.error("Lỗi khi thêm khu vực: ", error);
                        alert("Đã xảy ra lỗi khi thêm khu vực");
                    });
            }
        }
        
        // Add table
        function addTable(areaId) {
            isEditingTable = false;
            currentAreaId = areaId;
            modalTableTitle.textContent = "Thêm bàn mới";
            tableNumberInput.value = "";
            tableCapacityInput.value = "4";
            tableStatusInput.value = "available";
            tableNumberError.style.display = 'none';
            tableModal.style.display = "flex";
        }
        
        // Edit table
        function editTable(areaId, tableId) {
            areasRef.child(areaId).child('tables').child(tableId).once('value', (snapshot) => {
                const table = snapshot.val();
                if (table) {
                    isEditingTable = true;
                    currentAreaId = areaId;
                    currentTableId = tableId;
                    modalTableTitle.textContent = "Chỉnh sửa bàn";
                    tableNumberInput.value = table.number;
                    tableCapacityInput.value = table.capacity;
                    tableStatusInput.value = table.status;
                    tableNumberError.style.display = 'none';
                    tableModal.style.display = "flex";
                }
            });
        }
        
        // Delete table
        function deleteTable(areaId, tableId) {
            if (confirm("Bạn có chắc chắn muốn xóa bàn này?")) {
                areasRef.child(areaId).child('tables').child(tableId).remove()
                    .then(() => {
                        console.log("Bàn đã được xóa");
                    })
                    .catch(error => {
                        console.error("Lỗi khi xóa bàn: ", error);
                        alert("Đã xảy ra lỗi khi xóa bàn");
                    });
            }
        }
        
        // Save table (add or edit)
        function saveTable() {
            const number = tableNumberInput.value.trim();
            const capacity = parseInt(tableCapacityInput.value);
            const status = tableStatusInput.value;
            
            if (!number) {
                alert("Vui lòng nhập số bàn");
                return;
            }
            
            if (isNaN(capacity) || capacity < 2 || capacity > 20) {
                alert("Sức chứa phải từ 2 đến 20 người");
                return;
            }
            
            const tableData = {
                number: number,
                capacity: capacity,
                status: status,
                guests: 0
            };
            
            if (isEditingTable) {
                // Update existing table
                areasRef.child(currentAreaId).child('tables').child(currentTableId).update(tableData)
                    .then(() => {
                        tableModal.style.display = "none";
                    })
                    .catch(error => {
                        console.error("Lỗi khi cập nhật bàn: ", error);
                        alert("Đã xảy ra lỗi khi cập nhật bàn");
                    });
            } else {
                // Add new table
                areasRef.child(currentAreaId).child('tables').push(tableData)
                    .then(() => {
                        tableModal.style.display = "none";
                    })
                    .catch(error => {
                        console.error("Lỗi khi thêm bàn: ", error);
                        alert("Đã xảy ra lỗi khi thêm bàn");
                    });
            }
        }
        
        // Edit debt
        function editDebt(debtId) {
            debtsRef.child(debtId).once('value', (snapshot) => {
                const debt = snapshot.val();
                if (debt) {
                    isEditingDebt = true;
                    currentDebtId = debtId;
                    modalDebtTitle.textContent = "Chỉnh sửa công nợ";
                    
                    debtNameInput.value = debt.name;
                    debtTypeInput.value = debt.type;
                    debtAmountInput.value = debt.amount;
                    
                    // Format date for input
                    const debtDate = new Date(debt.createdAt);
                    const year = debtDate.getFullYear();
                    const month = String(debtDate.getMonth() + 1).padStart(2, '0');
                    const day = String(debtDate.getDate()).padStart(2, '0');
                    debtDateInput.value = `${year}-${month}-${day}`;
                    
                    debtStatusInput.value = debt.status;
                    
                    debtModal.style.display = "flex";
                }
            });
        }
        
        // Delete debt
        function deleteDebt(debtId) {
            if (confirm("Bạn có chắc chắn muốn xóa công nợ này?")) {
                debtsRef.child(debtId).remove()
                    .then(() => {
                        console.log("Công nợ đã được xóa");
                    })
                    .catch(error => {
                        console.error("Lỗi khi xóa công nợ: ", error);
                        alert("Đã xảy ra lỗi khi xóa công nợ");
                    });
            }
        }
        
        // Save debt (add or edit)
        function saveDebt() {
            const name = debtNameInput.value.trim();
            const type = debtTypeInput.value;
            const amount = parseFloat(debtAmountInput.value);
            const date = debtDateInput.value;
            const status = debtStatusInput.value;
            
            if (!name) {
                alert("Vui lòng nhập tên công nợ");
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                alert("Vui lòng nhập số tiền hợp lệ");
                return;
            }
            
            if (!date) {
                alert("Vui lòng chọn ngày tạo");
                return;
            }
            
            // Convert date to timestamp
            const createdAt = new Date(date).getTime();
            
            const debtData = {
                name: name,
                type: type,
                amount: amount,
                createdAt: createdAt,
                status: status
            };
            
            if (isEditingDebt) {
                // Update existing debt
                debtsRef.child(currentDebtId).update(debtData)
                    .then(() => {
                        debtModal.style.display = "none";
                    })
                    .catch(error => {
                        console.error("Lỗi khi cập nhật công nợ: ", error);
                        alert("Đã xảy ra lỗi khi cập nhật công nợ");
                    });
            } else {
                // Add new debt
                debtsRef.push(debtData)
                    .then(() => {
                        debtModal.style.display = "none";
                    })
                    .catch(error => {
                        console.error("Lỗi khi thêm công nợ: ", error);
                        alert("Đã xảy ra lỗi khi thêm công nợ");
                    });
            }
        }
        
        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        // Update date and time display
        function updateDateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString('vi-VN', { 
                weekday: 'long', 
                day: 'numeric', 
                month: 'long', 
                year: 'numeric'
            });
            currentDateTime.textContent = `lúc ${timeString} ${dateString}`;
        }
    </script>
</body>
</html>