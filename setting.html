<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Cài đặt tài khoản - Foodiee Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
      --warning: #f39c12;
      --gray: #95a5a6;
      --sidebar-width: 250px;
      --sidebar-collapsed: 70px;
      --transition-speed: 0.3s;
      --premium: #f39c12;
      --pro: #3498db;
      --base: #2c3e50;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      overflow-x: hidden;
      display: flex;
      min-height: 100vh;
    }

    /* Header */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 2px solid var(--secondary);
      margin-bottom: 30px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .notification-icon {
      position: relative;
      cursor: pointer;
      font-size: 1.3rem;
      color: var(--primary);
      transition: transform 0.3s;
    }

    .notification-icon:hover {
      transform: scale(1.1);
      color: var(--accent);
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent);
      color: white;
      font-size: 0.7rem;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      background-size: cover;
      background-position: center;
    }

    .user-name {
      font-weight: 500;
      color: var(--primary);
    }

    /* Sidebar */
    .sidebar {
      background: linear-gradient(135deg, var(--primary), #1a2530);
      color: white;
      width: var(--sidebar-width);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      overflow-y: auto;
      transition: all var(--transition-speed) ease;
      box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar.closed {
      width: var(--sidebar-collapsed);
    }

    .toggle-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 100%;
      padding: 15px;
      cursor: pointer;
      text-align: left;
      display: flex;
      align-items: center;
      transition: background 0.3s;
    }

    .toggle-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .toggle-btn i {
      font-size: 1.5rem;
      margin-right: 15px;
    }

    .sidebar.closed .toggle-btn i {
      margin-right: 0;
    }

    .nav-menu {
      padding: 15px 0;
    }

    .nav-menu ul {
      list-style: none;
    }

    .nav-menu ul li {
      position: relative;
    }

    .nav-menu ul li a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .nav-menu ul li a:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-menu ul li a.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left: 4px solid var(--accent);
    }

    .nav-menu ul li a i {
      font-size: 1.2rem;
      min-width: 30px;
      text-align: center;
      transition: transform 0.3s;
    }

    .link-text {
      margin-left: 15px;
      transition: opacity var(--transition-speed), margin var(--transition-speed);
      white-space: nowrap;
    }

    .sidebar.closed .link-text {
      opacity: 0;
      margin-left: -10px;
      pointer-events: none;
    }

    /* Submenu */
    .submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      background: rgba(0, 0, 0, 0.15);
      padding-left: 0;
    }

    .submenu.show {
      max-height: 500px;
    }

    .submenu li a {
      padding: 12px 20px 12px 60px !important;
      font-size: 0.9rem;
    }

    .submenu li a i {
      font-size: 0.9rem;
    }

    /* Fix submenu khi sidebar đóng */
    .sidebar.closed .submenu {
      position: absolute;
      left: 100%;
      top: 0;
      min-width: 200px;
      background: #2c3e50;
      border-radius: 0 8px 8px 0;
      box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    .sidebar.closed .submenu.show {
      max-height: none;
      display: block;
    }

    .sidebar.closed .submenu li a {
      padding: 12px 15px !important;
    }

    .sidebar.closed .submenu .link-text {
      opacity: 1;
      margin-left: 10px;
      pointer-events: auto;
    }

    /* Main content */
    main {
      flex: 1;
      padding: 30px;
      margin-left: var(--sidebar-width);
      transition: margin var(--transition-speed);
      overflow-y: auto;
    }

    .sidebar.closed + main {
      margin-left: var(--sidebar-collapsed);
    }

    h1 {
      color: var(--primary);
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    /* Account Settings */
    .settings-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      margin-bottom: 30px;
      position: relative;
    }
    
    .settings-header {
      padding: 20px;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .settings-header i {
      font-size: 1.8rem;
    }
    
    .settings-body {
      padding: 30px;
    }
    
    .account-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .info-card {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #eee;
    }
    
    .info-card h3 {
      margin-bottom: 15px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .info-group {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .info-label {
      font-weight: 600;
      color: var(--gray);
      font-size: 0.9rem;
      margin-bottom: 5px;
    }
    
    .info-value {
      font-size: 1.1rem;
      color: var(--dark);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .form-control[disabled] {
      background: #f5f5f5;
      color: #777;
      cursor: not-allowed;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #2980b9;
    }
    
    .btn-secondary {
      background: #95a5a6;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #7f8c8d;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #27ae60;
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-warning:hover {
      background: #e67e22;
    }
    
    .btn-danger {
      background: var(--accent);
      color: white;
    }
    
    .btn-danger:hover {
      background: #c0392b;
    }
    
    .btn-premium {
      background: var(--premium);
      color: white;
    }
    
    .btn-premium:hover {
      background: #e67e22;
    }
    
    .btn-pro {
      background: var(--pro);
      color: white;
    }
    
    .btn-pro:hover {
      background: #2980b9;
    }
    
    .btn-base {
      background: var(--base);
      color: white;
    }
    
    .btn-base:hover {
      background: #1a252f;
    }
    
    .account-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    
    .action-card {
      flex: 1;
      min-width: 300px;
      background: #f8f9fa;
      border-radius: 10px;
      padding: 20px;
      border: 1px solid #eee;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    
    .action-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .action-card h3 {
      margin-bottom: 15px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .action-card p {
      color: var(--gray);
      margin-bottom: 20px;
      min-height: 60px;
    }
    
    .avatar-upload {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      border: 3px solid #eee;
      background-size: cover;
      background-position: center;
    }
    
    .qr-preview {
      width: 150px;
      height: 150px;
      border: 1px solid #eee;
      background-size: cover;
      background-position: center;
      margin-top: 10px;
    }
    
    .business-other {
      display: none;
      margin-top: 10px;
    }
    
    .edit-buttons {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
    }
    
    #edit-form {
      display: none;
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 3000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      animation: toastSlideIn 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .toast.error {
      background: var(--accent);
    }
    
    .toast.success {
      background: var(--success);
    }
    
    .toast.warning {
      background: var(--warning);
    }
    
    @keyframes toastSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 500px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      overflow: hidden;
    }
    
    .modal-header {
      background: var(--primary);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-modal {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .modal-footer {
      padding: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      border-top: 1px solid #eee;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .alert-info {
      background: rgba(52, 152, 219, 0.1);
      color: var(--secondary);
      border: 1px solid rgba(52, 152, 219, 0.2);
    }
    
    /* Responsive */
    @media (max-width: 992px) {
      .sidebar {
        width: var(--sidebar-collapsed);
      }
      
      .sidebar:not(.closed) {
        width: var(--sidebar-width);
      }
      
      main {
        margin-left: var(--sidebar-collapsed);
      }
      
      .sidebar:not(.closed) + main {
        margin-left: var(--sidebar-width);
      }
    }

    @media (max-width: 768px) {
      .account-info {
        grid-template-columns: 1fr;
      }
      
      .plans-container {
        grid-template-columns: 1fr;
      }
      
      .action-card {
        min-width: 100%;
      }
      
      .avatar-upload {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .edit-buttons {
        position: static;
        margin-top: 15px;
        justify-content: flex-end;
      }
      
      .modal-content {
        width: 90%;
        margin: 0 auto;
      }
    }

    @media (max-width: 480px) {
      .main-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .header-right {
        align-self: flex-end;
      }
      
      .account-actions {
        flex-direction: column;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .modal-footer .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>
    <nav class="nav-menu">
      <ul>
        <li><a href="tongquan.html"><i class="fas fa-chart-line"></i><span class="link-text">Tổng quan</span></a></li>
        <li><a href="quanlychinhanh.html"><i class="fas fa-building"></i><span class="link-text">Quản lý chi nhánh</span></a></li>
        <li>
          <a href="#" onclick="toggleBranchSubmenu()">
            <i class="fas fa-store-alt"></i>
            <span class="link-text">Quản lý nhà hàng</span>
            <i id="branch-arrow" class="fas fa-chevron-down" style="float: right;"></i>
          </a>
          <ul class="submenu" id="branch-submenu" style="display: none; padding-left: 20px;"></ul>
        </li>
        <li><a href="quanlynhanvien.html"><i class="fas fa-user-friends"></i><span class="link-text">Quản lý nhân viên</span></a></li>
        <li><a href="quanlydanhmuc.html"><i class="fas fa-list-alt"></i><span class="link-text">Quản lý danh mục</span></a></li>
        <li><a href="quanlymenu.html"><i class="fas fa-utensils"></i><span class="link-text">Quản lý menu</span></a></li>
        <li><a href="quanlykhachhang.html"><i class="fas fa-user"></i><span class="link-text">Quản lý khách hàng</span></a></li>  
        <li><a href="quanlyvoucher.html"><i class="fas fa-ticket-alt"></i><span class="link-text">Quản lý voucher</span></a></li>
        <li><a href="setting.html" class="active"><i class="fas fa-cogs"></i><span class="link-text">Cài đặt</span></a></li>
      </ul>
    </nav>
  </div>
  
  <main>
    <div class="main-header">
      <h1>Cài đặt tài khoản</h1>
      <div class="header-right">
        <div class="notification-icon" onclick="toggleNotifications()">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notification-badge">0</span>
        </div>
        <div class="user-profile">
          <div class="avatar" id="header-avatar">A</div>
          <span class="user-name" id="header-username">Admin</span>
        </div>
      </div>
    </div>
    
    <div class="settings-container">
      <div class="edit-buttons">
        <button class="btn btn-primary" id="edit-button" onclick="toggleEditMode(true)">
          <i class="fas fa-edit"></i> Chỉnh sửa
        </button>
        <button class="btn btn-secondary" id="cancel-button" onclick="toggleEditMode(false)" style="display:none;">
          <i class="fas fa-times"></i> Hủy
        </button>
      </div>
      
      <div class="settings-header">
        <i class="fas fa-user-circle"></i>
        <h2>Thông tin tài khoản</h2>
      </div>
      
      <div class="settings-body">
        <!-- View Mode -->
        <div id="view-mode">
          <div class="account-info">
            <div class="info-card">
              <h3><i class="fas fa-info-circle"></i> Thông tin cơ bản</h3>
              <div class="info-group">
                <div class="info-label">Email</div>
                <div class="info-value" id="email-value">user@example.com</div>
              </div>
              <div class="info-group">
                <div class="info-label">Tên hiển thị</div>
                <div class="info-value" id="display-name">Nguyễn Văn A</div>
              </div>
              <div class="info-group">
                <div class="info-label">Số điện thoại</div>
                <div class="info-value" id="phone-value">0987654321</div>
              </div>
            </div>
            
            <div class="info-card">
              <h3><i class="fas fa-store"></i> Thông tin quán</h3>
              <div class="info-group">
                <div class="info-label">Tên quán</div>
                <div class="info-value" id="restaurant-name">Nhà hàng Foodiee</div>
              </div>
              <div class="info-group">
                <div class="info-label">Lĩnh vực hoạt động</div>
                <div class="info-value" id="business-type">Nhà hàng</div>
              </div>
              <div class="info-group">
                <div class="info-label">Tên ngân hàng</div>
                <div class="info-value" id="bank-name">Vietcombank</div>
              </div>
              <div class="info-group">
                <div class="info-label">Số tài khoản</div>
                <div class="info-value" id="bank-account">0123456789</div>
              </div>
              <div class="info-group">
                <div class="info-label">Tên chủ tài khoản</div>
                <div class="info-value" id="account-holder">NGUYEN VAN A</div>
              </div>
              <div class="info-group">
                <div class="info-label">QR Code</div>
                <div class="qr-preview" id="qr-preview-view" style="background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/QR_code_for_mobile_English_Wikipedia.svg/1200px-QR_code_for_mobile_English_Wikipedia.svg.png')"></div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Edit Mode -->
        <form id="edit-form">
          <div class="account-info">
            <div class="info-card">
              <h3><i class="fas fa-info-circle"></i> Thông tin cơ bản</h3>
              <div class="form-group">
                <label for="displayName">Tên hiển thị *</label>
                <input type="text" id="displayName" class="form-control" placeholder="Nhập tên hiển thị">
              </div>
              
              <div class="form-group">
                <label for="phone">Số điện thoại *</label>
                <input type="tel" id="phone" class="form-control" placeholder="Nhập số điện thoại">
              </div>
            </div>
            
            <div class="info-card">
              <h3><i class="fas fa-store"></i> Thông tin quán</h3>
              <div class="form-group">
                <label for="restaurantName">Tên quán *</label>
                <input type="text" id="restaurantName" class="form-control" placeholder="Nhập tên quán">
              </div>
              
              <div class="form-group">
                <label for="businessType">Lĩnh vực hoạt động *</label>
                <select id="businessType" class="form-control">
                  <option value="restaurant">Nhà hàng</option>
                  <option value="cafe">Quán nước</option>
                  <option value="grocery">Tạp hóa</option>
                  <option value="other">Khác</option>
                </select>
              </div>
              
              <div class="form-group business-other" id="business-other-group">
                <label for="businessOther">Mô tả lĩnh vực *</label>
                <input type="text" id="businessOther" class="form-control" placeholder="Nhập lĩnh vực hoạt động">
              </div>
              
              <div class="form-group">
                <label for="bankName">Tên ngân hàng *</label>
                <input type="text" id="bankName" class="form-control" placeholder="Nhập tên ngân hàng">
              </div>
              
              <div class="form-group">
                <label for="bankAccount">Số tài khoản *</label>
                <input type="text" id="bankAccount" class="form-control" placeholder="Nhập số tài khoản">
              </div>
              
              <div class="form-group">
                <label for="accountHolder">Tên chủ tài khoản *</label>
                <input type="text" id="accountHolder" class="form-control" placeholder="Nhập tên chủ tài khoản">
              </div>
              
              <div class="form-group">
                <label for="qrImage">QR Code thanh toán</label>
                <div class="avatar-upload">
                  <div class="qr-preview" id="qr-preview-edit"></div>
                  <div>
                    <input type="hidden" role="uploadcare-uploader" id="uploadcare-qr-widget" data-public-key="238c599562905655c2c8" />
                    <div class="info-label">Tải lên ảnh QR Code</div>
                    <div class="info-value">(Ảnh sẽ được lưu trữ trên Uploadcare)</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <button type="button" class="btn btn-primary" onclick="updateAccountInfo()">
            <i class="fas fa-save"></i> Cập nhật thông tin
          </button>
        </form>
        
        <div class="account-actions">
          <div class="action-card">
            <h3><i class="fas fa-key"></i> Đổi mật khẩu</h3>
            <p>Bạn có thể thay đổi mật khẩu tài khoản tại đây. Hãy đảm bảo mật khẩu đủ mạnh và bảo mật.</p>
            <button class="btn btn-warning" onclick="openChangePassword()">
              <i class="fas fa-lock"></i> Đổi mật khẩu
            </button>
          </div>
          
          <div class="action-card">
            <h3><i class="fas fa-sign-out-alt"></i> Đăng xuất</h3>
            <p>Đăng xuất khỏi tài khoản hiện tại. Bạn sẽ cần đăng nhập lại để tiếp tục sử dụng hệ thống.</p>
            <button class="btn btn-danger" onclick="logout()">
              <i class="fas fa-sign-out-alt"></i> Đăng xuất
            </button>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Change Password Modal -->
  <div class="modal" id="password-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2><i class="fas fa-key"></i> Đổi mật khẩu</h2>
        <button class="close-modal" onclick="closePasswordModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="currentPassword">Mật khẩu hiện tại *</label>
          <input type="password" id="currentPassword" class="form-control" placeholder="Nhập mật khẩu hiện tại">
        </div>
        
        <div class="form-group">
          <label for="newPassword">Mật khẩu mới *</label>
          <input type="password" id="newPassword" class="form-control" placeholder="Nhập mật khẩu mới">
        </div>
        
        <div class="form-group">
          <label for="confirmPassword">Xác nhận mật khẩu *</label>
          <input type="password" id="confirmPassword" class="form-control" placeholder="Nhập lại mật khẩu mới">
        </div>
        
        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i> Mật khẩu phải có ít nhất 8 ký tự, bao gồm chữ hoa, chữ thường, số và ký tự đặc biệt.
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePasswordModal()">Hủy</button>
        <button class="btn btn-primary" onclick="changePassword()">Cập nhật mật khẩu</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBzAdWAVjD_NQP3uglLYOOFWUmDGsylsg0",
      authDomain: "foodiee-fcdc1.firebaseapp.com",
      databaseURL: "https://foodiee-fcdc1-default-rtdb.firebaseio.com",
      projectId: "foodiee-fcdc1",
      storageBucket: "foodiee-fcdc1.appspot.com",
      messagingSenderId: "993331259398",
      appId: "1:993331259398:web:2b922ef5e0519d5e237b87",
      measurementId: "G-PDT1VE8JL5"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    // Biến toàn cục
    let currentUser = null;
    let uploadcareWidget = null;
    let qrUploadcareWidget = null;
    
    // Toggle sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('closed');
      
      // Lưu trạng thái sidebar vào localStorage
      const isClosed = sidebar.classList.contains('closed');
      localStorage.setItem('sidebarClosed', isClosed);
    }

    // Toggle notifications
    function toggleNotifications() {
      // Placeholder function
    }
    
    // Hiển thị thông báo
    function showToast(message, type) {
      // Remove existing toasts
      const existingToasts = document.querySelectorAll('.toast');
      existingToasts.forEach(toast => toast.remove());
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Chuyển đổi giữa chế độ xem và chỉnh sửa
    function toggleEditMode(isEditMode) {
      const viewMode = document.getElementById('view-mode');
      const editForm = document.getElementById('edit-form');
      const editButton = document.getElementById('edit-button');
      const cancelButton = document.getElementById('cancel-button');
      
      if (isEditMode) {
        viewMode.style.display = 'none';
        editForm.style.display = 'block';
        editButton.style.display = 'none';
        cancelButton.style.display = 'inline-flex';
      } else {
        viewMode.style.display = 'block';
        editForm.style.display = 'none';
        editButton.style.display = 'inline-flex';
        cancelButton.style.display = 'none';
      }
    }
    
    // Lắng nghe trạng thái đăng nhập
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        document.getElementById('header-username').textContent = user.displayName || user.email.split('@')[0];
        document.getElementById('header-avatar').textContent = user.displayName?.charAt(0) || user.email.charAt(0);
        
        // Load user info
        loadUserInfo();
      } else {
        // Redirect to login if not authenticated
        window.location.href = 'login.html';
      }
    });
    
    // Tải thông tin người dùng
    function loadUserInfo() {
      if (!currentUser) return;
      
      const userInfoRef = database.ref(`users/${currentUser.uid}/info_user`);
      
      userInfoRef.once('value')
        .then(snapshot => {
          const userInfo = snapshot.val();
          
          // Set initial values
          document.getElementById('email-value').textContent = currentUser.email;
          
          if (userInfo) {
            // Set display values
            document.getElementById('display-name').textContent = userInfo.displayName || 'Chưa cập nhật';
            document.getElementById('phone-value').textContent = userInfo.phone || 'Chưa cập nhật';
            document.getElementById('restaurant-name').textContent = userInfo.restaurantName || 'Chưa cập nhật';
            document.getElementById('bank-name').textContent = userInfo.bankName || 'Chưa cập nhật';
            document.getElementById('bank-account').textContent = userInfo.bankAccount || 'Chưa cập nhật';
            document.getElementById('account-holder').textContent = userInfo.accountHolder || 'Chưa cập nhật';
            document.getElementById('business-type').textContent = getBusinessTypeText(userInfo.businessType, userInfo.businessOther);
            
            // Set form values
            document.getElementById('displayName').value = userInfo.displayName || '';
            document.getElementById('phone').value = userInfo.phone || '';
            document.getElementById('restaurantName').value = userInfo.restaurantName || '';
            document.getElementById('bankName').value = userInfo.bankName || '';
            document.getElementById('bankAccount').value = userInfo.bankAccount || '';
            document.getElementById('accountHolder').value = userInfo.accountHolder || '';
            
            // Set business type
            const businessType = userInfo.businessType || 'restaurant';
            document.getElementById('businessType').value = businessType;
            
            // Set business type display
            let businessTypeText = 'Nhà hàng';
            if (businessType === 'cafe') businessTypeText = 'Quán nước';
            else if (businessType === 'grocery') businessTypeText = 'Tạp hóa';
            else if (businessType === 'other') businessTypeText = userInfo.businessOther || 'Khác';
            
            // Show/hide other field
            toggleBusinessOther(businessType);
            
            // Set other value if exists
            if (businessType === 'other' && userInfo.businessOther) {
              document.getElementById('businessOther').value = userInfo.businessOther;
            }
            
            // Set avatar
            if (userInfo.avatarUrl) {
              document.getElementById('header-avatar').style.backgroundImage = `url(${userInfo.avatarUrl})`;
              document.getElementById('header-avatar').textContent = '';
            }
            
            // Set QR code
            if (userInfo.qrUrl) {
              document.getElementById('qr-preview-view').style.backgroundImage = `url(${userInfo.qrUrl})`;
              document.getElementById('qr-preview-edit').style.backgroundImage = `url(${userInfo.qrUrl})`;
            }
          }
        })
        .catch(error => {
          console.error('Error loading user info:', error);
          showToast('Lỗi khi tải thông tin tài khoản', 'error');
        });
      
      // Initialize QR Uploadcare widget
      if (!qrUploadcareWidget) {
        const widgetElement = document.getElementById('uploadcare-qr-widget');
        qrUploadcareWidget = uploadcare.Widget(widgetElement);
        
        qrUploadcareWidget.onChange(function(file) {
          if (file) {
            file.done(function(info) {
              // Update preview
              document.getElementById('qr-preview-edit').style.backgroundImage = `url(${info.cdnUrl})`;
              
              // Save to Firebase
              database.ref(`users/${currentUser.uid}/info_user/qrUrl`).set(info.cdnUrl)
                .then(() => {
                  // Update QR view
                  document.getElementById('qr-preview-view').style.backgroundImage = `url(${info.cdnUrl})`;
                  showToast('Cập nhật QR code thành công!', 'success');
                })
                .catch(error => {
                  console.error('Error saving QR:', error);
                  showToast('Có lỗi khi lưu QR code', 'error');
                });
            });
          }
        });
      }
    }
    
    // Lấy tên loại hình kinh doanh
    function getBusinessTypeText(type, other) {
      if (type === 'restaurant') return 'Nhà hàng';
      if (type === 'cafe') return 'Quán nước';
      if (type === 'grocery') return 'Tạp hóa';
      if (type === 'other') return other || 'Khác';
      return 'Chưa cập nhật';
    }
    
    // Toggle business other field
    function toggleBusinessOther(type) {
      const otherGroup = document.getElementById('business-other-group');
      if (type === 'other') {
        otherGroup.style.display = 'block';
      } else {
        otherGroup.style.display = 'none';
      }
    }
    
    // Listen to business type change
    document.getElementById('businessType').addEventListener('change', function() {
      toggleBusinessOther(this.value);
    });
    
    // Cập nhật thông tin tài khoản
    function updateAccountInfo() {
      if (!currentUser) return;
      
      // Get form values
      const displayName = document.getElementById('displayName').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const restaurantName = document.getElementById('restaurantName').value.trim();
      const businessType = document.getElementById('businessType').value;
      const businessOther = businessType === 'other' ? document.getElementById('businessOther').value.trim() : '';
      const bankName = document.getElementById('bankName').value.trim();
      const bankAccount = document.getElementById('bankAccount').value.trim();
      const accountHolder = document.getElementById('accountHolder').value.trim();
      
      // Validation
      if (!displayName) {
        showToast('Vui lòng nhập tên hiển thị', 'error');
        return;
      }
      
      if (!phone) {
        showToast('Vui lòng nhập số điện thoại', 'error');
        return;
      }
      
      if (!restaurantName) {
        showToast('Vui lòng nhập tên quán', 'error');
        return;
      }
      
      if (businessType === 'other' && !businessOther) {
        showToast('Vui lòng nhập lĩnh vực hoạt động', 'error');
        return;
      }
      
      if (!bankName) {
        showToast('Vui lòng nhập tên ngân hàng', 'error');
        return;
      }
      
      if (!bankAccount) {
        showToast('Vui lòng nhập số tài khoản', 'error');
        return;
      }
      
      if (!accountHolder) {
        showToast('Vui lòng nhập tên chủ tài khoản', 'error');
        return;
      }
      
      // Prepare data
      const userInfo = {
        displayName: displayName,
        phone: phone,
        restaurantName: restaurantName,
        businessType: businessType,
        bankName: bankName,
        bankAccount: bankAccount,
        accountHolder: accountHolder
      };
      
      if (businessType === 'other') {
        userInfo.businessOther = businessOther;
      }
      
      // Save to Firebase
      database.ref(`users/${currentUser.uid}/info_user`).update(userInfo)
        .then(() => {
          // Update display values
          document.getElementById('display-name').textContent = displayName;
          document.getElementById('phone-value').textContent = phone;
          document.getElementById('restaurant-name').textContent = restaurantName;
          document.getElementById('bank-name').textContent = bankName;
          document.getElementById('bank-account').textContent = bankAccount;
          document.getElementById('account-holder').textContent = accountHolder;
          document.getElementById('business-type').textContent = getBusinessTypeText(businessType, businessOther);
          
          // Update user profile
          document.getElementById('header-username').textContent = displayName;
          document.getElementById('header-avatar').textContent = displayName.charAt(0);
          
          // Quay về chế độ xem
          toggleEditMode(false);
          
          showToast('Cập nhật thông tin thành công!', 'success');
        })
        .catch(error => {
          console.error('Error updating user info:', error);
          showToast('Có lỗi xảy ra: ' + error.message, 'error');
        });
    }
    
    // Mở modal đổi mật khẩu
    function openChangePassword() {
      document.getElementById('password-modal').style.display = 'flex';
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }
    
    // Đóng modal đổi mật khẩu
    function closePasswordModal() {
      document.getElementById('password-modal').style.display = 'none';
    }
    
    // Đổi mật khẩu
    function changePassword() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!currentPassword || !newPassword || !confirmPassword) {
        showToast('Vui lòng điền đầy đủ thông tin', 'error');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showToast('Mật khẩu mới và xác nhận không khớp', 'error');
        return;
      }
      
      if (newPassword.length < 8) {
        showToast('Mật khẩu phải có ít nhất 8 ký tự', 'error');
        return;
      }
      
      // Reauthenticate user
      const credential = firebase.auth.EmailAuthProvider.credential(
        currentUser.email, 
        currentPassword
      );
      
      currentUser.reauthenticateWithCredential(credential)
        .then(() => {
          // Change password
          currentUser.updatePassword(newPassword)
            .then(() => {
              showToast('Đổi mật khẩu thành công!', 'success');
              closePasswordModal();
            })
            .catch(error => {
              console.error('Error changing password:', error);
              showToast('Có lỗi khi đổi mật khẩu: ' + error.message, 'error');
            });
        })
        .catch(error => {
          console.error('Error reauthenticating:', error);
          showToast('Mật khẩu hiện tại không đúng', 'error');
        });
    }
    
    // Đăng xuất
    function logout() {
      firebase.auth().signOut()
        .then(() => {
          window.location.href = 'login.html';
        })
        .catch(error => {
          console.error('Error signing out:', error);
          showToast('Có lỗi khi đăng xuất', 'error');
        });
    }
    
    // Khởi tạo trạng thái sidebar từ localStorage
    document.addEventListener('DOMContentLoaded', function() {
      const isClosed = localStorage.getItem('sidebarClosed') === 'true';
      if (isClosed) {
        document.getElementById('sidebar').classList.add('closed');
      }
      
      // Ẩn form chỉnh sửa khi tải trang
      document.getElementById('edit-form').style.display = 'none';
      
      // Đảm bảo modal đổi mật khẩu ẩn khi tải trang
      document.getElementById('password-modal').style.display = 'none';
    });
  </script>
</body>
</html>