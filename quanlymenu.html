<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Quản lý Menu - Foodiee Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
      --warning: #f39c12;
      --gray: #95a5a6;
      --sidebar-width: 250px;
      --sidebar-collapsed: 70px;
      --transition-speed: 0.3s;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      overflow-x: hidden;
      display: flex;
      min-height: 100vh;
    }

    /* Header */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 2px solid var(--secondary);
      margin-bottom: 30px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .notification-icon {
      position: relative;
      cursor: pointer;
      font-size: 1.3rem;
      color: var(--primary);
      transition: transform 0.3s;
    }

    .notification-icon:hover {
      transform: scale(1.1);
      color: var(--accent);
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent);
      color: white;
      font-size: 0.7rem;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      background-size: cover;
      background-position: center;
    }

    .user-name {
      font-weight: 500;
      color: var(--primary);
    }

    /* Sidebar */
    .sidebar {
      background: linear-gradient(135deg, var(--primary), #1a2530);
      color: white;
      width: var(--sidebar-width);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      overflow-y: auto;
      transition: all var(--transition-speed) ease;
      box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar.closed {
      width: var(--sidebar-collapsed);
    }

    .toggle-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 100%;
      padding: 15px;
      cursor: pointer;
      text-align: left;
      display: flex;
      align-items: center;
      transition: background 0.3s;
    }

    .toggle-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .toggle-btn i {
      font-size: 1.5rem;
      margin-right: 15px;
    }

    .sidebar.closed .toggle-btn i {
      margin-right: 0;
    }

    .nav-menu {
      padding: 15px 0;
    }

    .nav-menu ul {
      list-style: none;
    }

    .nav-menu ul li {
      position: relative;
    }

    .nav-menu ul li a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .nav-menu ul li a:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-menu ul li a.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left: 4px solid var(--accent);
    }

    .nav-menu ul li a i {
      font-size: 1.2rem;
      min-width: 30px;
      text-align: center;
      transition: transform 0.3s;
    }

    .link-text {
      margin-left: 15px;
      transition: opacity var(--transition-speed), margin var(--transition-speed);
      white-space: nowrap;
    }

    .sidebar.closed .link-text {
      opacity: 0;
      margin-left: -10px;
      pointer-events: none;
    }

    /* Submenu */
    .submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      background: rgba(0, 0, 0, 0.15);
      padding-left: 0;
    }

    .submenu.show {
      max-height: 500px;
    }

    .submenu li a {
      padding: 12px 20px 12px 60px !important;
      font-size: 0.9rem;
    }

    .submenu li a i {
      font-size: 0.9rem;
    }

    /* Fix submenu khi sidebar đóng */
    .sidebar.closed .submenu {
      position: absolute;
      left: 100%;
      top: 0;
      min-width: 200px;
      background: #2c3e50;
      border-radius: 0 8px 8px 0;
      box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    .sidebar.closed .submenu.show {
      max-height: none;
      display: block;
    }

    .sidebar.closed .submenu li a {
      padding: 12px 15px !important;
    }

    .sidebar.closed .submenu .link-text {
      opacity: 1;
      margin-left: 10px;
      pointer-events: auto;
    }

    /* Main content */
    main {
      flex: 1;
      padding: 30px;
      margin-left: var(--sidebar-width);
      transition: margin var(--transition-speed);
      overflow-y: auto;
      max-height: 100vh;
    }

    .sidebar.closed + main {
      margin-left: var(--sidebar-collapsed);
    }

    h1 {
      color: var(--primary);
      font-weight: 600;
    }
    
    /* Menu Management Styles */
    .menu-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      overflow: hidden;
      margin-bottom: 30px;
    }
    
    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #eee;
    }
    
    .btn {
      padding: 10px 20px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: var(--secondary);
      color: white;
    }
    
    .btn-primary:hover {
      background: #2980b9;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-success:hover {
      background: #27ae60;
    }
    
    .btn-danger {
      background: var(--accent);
      color: white;
    }
    
    .btn-danger:hover {
      background: #c0392b;
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-warning:hover {
      background: #e67e22;
    }
    
    .menu-controls {
      display: flex;
      gap: 15px;
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    
    .search-box {
      flex: 1;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 10px 15px 10px 40px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    
    .menu-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .menu-table th {
      background: var(--light);
      padding: 15px;
      text-align: left;
      color: var(--primary);
      font-weight: 600;
      border-bottom: 2px solid #ddd;
    }
    
    .menu-table td {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .menu-table tr:hover {
      background: #f9f9f9;
    }
    
    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-block;
      min-width: 80px;
      text-align: center;
    }
    
    .status-active {
      background: rgba(46, 204, 113, 0.15);
      color: var(--success);
    }
    
    .status-inactive {
      background: rgba(231, 76, 60, 0.15);
      color: var(--accent);
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      padding: 5px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .action-btn.edit {
      background: rgba(52, 152, 219, 0.15);
      color: var(--secondary);
    }
    
    .action-btn.edit:hover {
      background: var(--secondary);
      color: white;
    }
    
    .action-btn.delete {
      background: rgba(231, 76, 60, 0.15);
      color: var(--accent);
    }
    
    .action-btn.delete:hover {
      background: var(--accent);
      color: white;
    }

    .action-btn.disable {
      background: rgba(243, 156, 18, 0.15);
      color: var(--warning);
    }
    
    .action-btn.disable:hover {
      background: var(--warning);
      color: white;
    }
    
    .action-btn.enable {
      background: rgba(46, 204, 113, 0.15);
      color: var(--success);
    }
    
    .action-btn.enable:hover {
      background: var(--success);
      color: white;
    }

    .action-btn.disabled {
      background: rgba(149, 165, 166, 0.15);
      color: var(--gray);
      cursor: not-allowed;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      overflow: auto;
    }
    
    .modal-content {
      background: white;
      width: 90%;
      max-width: 800px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      animation: modalAppear 0.3s ease;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    
    @keyframes modalAppear {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      padding: 20px;
      background: var(--primary);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .modal-header h3 {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s;
    }
    
    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .form-row .form-group {
      flex: 1;
      margin-bottom: 0;
    }
    
    .form-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 20px;
      border-top: 1px solid #eee;
      flex-shrink: 0;
    }
    
    /* Uploadcare Image Upload */
    .uploadcare-widget-button {
      background: var(--secondary) !important;
      border-radius: 4px !important;
    }
    
    .image-preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .image-preview {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      border: 1px solid #eee;
      background-size: cover;
      background-position: center;
      position: relative;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .remove-image {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--accent);
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 0.8rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    /* Branches selection */
    .branches-selection {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 10px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
    }
    
    .branch-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      padding: 8px;
      border-radius: 6px;
      transition: background 0.2s;
    }
    
    .branch-item:hover {
      background: #e9ecef;
    }
    
    .branch-item input {
      margin-right: 10px;
    }
    
    /* Product type specific */
    .product-type-group {
      display: flex;
      gap: 20px;
      margin-bottom: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #ddd;
    }
    
    .product-type-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      padding: 8px 15px;
      border-radius: 6px;
      background: white;
      border: 1px solid #ddd;
      transition: all 0.3s;
    }
    
    .product-type-option.active {
      background: var(--secondary);
      color: white;
      border-color: var(--secondary);
    }
    
    .product-type-option input {
      margin: 0;
    }
    
    /* Hidden until side product is selected */
    .side-product-options {
      display: none;
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      margin-top: 15px;
      border: 1px solid #ddd;
    }
    
    /* Uploadcare container */
    .uploadcare-container {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #ddd;
      margin-top: 10px;
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 3000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      animation: toastSlideIn 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .toast.error {
      background: var(--accent);
    }
    
    .toast.success {
      background: var(--success);
    }
    
    .toast.warning {
      background: var(--warning);
    }
    
    @keyframes toastSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Form icons */
    .form-icon {
      position: absolute;
      left: 15px;
      top: 40px;
      color: var(--gray);
      font-size: 16px;
    }
    
    /* Error message */
    .error-message {
      color: var(--accent);
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }
    
    /* Empty state */
    .empty-state {
      padding: 30px;
      text-align: center;
      color: var(--gray);
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
      color: #e0e0e0;
    }
    
    .empty-state p {
      font-size: 18px;
    }
    
    /* Confirm modal */
    .confirm-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    .confirm-content {
      background: white;
      border-radius: 10px;
      padding: 25px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    .confirm-content h3 {
      margin-bottom: 15px;
      color: var(--dark);
    }
    
    .confirm-content p {
      margin-bottom: 25px;
      color: var(--gray);
    }
    
    .confirm-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    /* Responsive */
    @media (max-width: 992px) {
      .sidebar {
        width: var(--sidebar-collapsed);
      }
      
      .sidebar:not(.closed) {
        width: var(--sidebar-width);
      }
      
      main {
        margin-left: var(--sidebar-collapsed);
      }
      
      .sidebar:not(.closed) + main {
        margin-left: var(--sidebar-width);
      }
      
      .menu-table {
        display: block;
        overflow-x: auto;
      }
    }

    @media (max-width: 768px) {
      .menu-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 20px;
      }
      
      .action-buttons {
        flex-wrap: wrap;
      }
      
      .modal-content {
        width: 95%;
      }
      
      .product-type-group {
        flex-direction: column;
      }
      
      .confirm-buttons {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .main-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .header-right {
        align-self: flex-end;
      }
      
      .menu-controls {
        flex-direction: column;
      }
      
      .form-footer {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>
    <nav class="nav-menu">
      <ul>
        <li><a href="tongquan.html"><i class="fas fa-chart-line"></i><span class="link-text">Tổng quan</span></a></li>
        <li><a href="quanlychinhanh.html"><i class="fas fa-building"></i><span class="link-text">Quản lý chi nhánh</span></a></li>
        <li>
          <a href="#" onclick="toggleBranchSubmenu()">
            <i class="fas fa-store-alt"></i>
            <span class="link-text">Quản lý nhà hàng</span>
            <i id="branch-arrow" class="fas fa-chevron-down" style="float: right;"></i>
          </a>
          <ul class="submenu" id="branch-submenu" style="display: none; padding-left: 20px;"></ul>
        </li>
        <li><a href="quanlynhanvien.html"><i class="fas fa-user-friends"></i><span class="link-text">Quản lý nhân viên</span></a></li>
        <li><a href="quanlydanhmuc.html"><i class="fas fa-list-alt"></i><span class="link-text">Quản lý danh mục</span></a></li>
        <li><a href="quanlymenu.html" class="active"><i class="fas fa-utensils"></i><span class="link-text">Quản lý menu</span></a></li>
        <li><a href="quanlykhachhang.html"><i class="fas fa-user"></i><span class="link-text">Quản lý khách hàng</span></a></li>  
        <li><a href="quanlyvoucher.html"><i class="fas fa-ticket-alt"></i><span class="link-text">Quản lý voucher</span></a></li>
        <li><a href="setting.html"><i class="fas fa-cogs"></i><span class="link-text">Cài đặt</span></a></li>
      </ul>
    </nav>
  </div>

  <main>
    <div class="main-header">
      <h1>Quản lý Menu</h1>
      <div class="header-right">
        <div class="notification-icon" onclick="toggleNotifications()">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notification-badge">0</span>
        </div>
        <div class="user-profile">
          <div class="avatar" id="header-avatar">A</div>
          <span class="user-name" id="header-username">Admin</span>
        </div>
      </div>
    </div>
    
    <!-- Menu Management Content -->
    <div class="menu-container">
      <div class="menu-header">
        <h2>Danh sách món ăn</h2>
        <button class="btn btn-primary" onclick="openMenuModal('add')">
          <i class="fas fa-plus"></i> Thêm món mới
        </button>
      </div>
      
      <div class="menu-controls">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="menu-search" placeholder="Tìm kiếm theo mã, tên..." oninput="filterMenu()">
        </div>
      </div>
      
      <div class="table-responsive">
        <table class="menu-table">
          <thead>
            <tr>
              <th>Mã món</th>
              <th>Tên món</th>
              <th>Phân hệ</th>
              <th>Giá (VNĐ)</th>
              <th>Trạng thái</th>
              <th>Ảnh</th>
              <th>Hành động</th>
            </tr>
          </thead>
          <tbody id="menu-list">
            <!-- Menu data will be loaded here -->
          </tbody>
        </table>
      </div>
      
      <div id="empty-menu-state" class="empty-state" style="display: none;">
        <i class="fas fa-utensils"></i>
        <p>Bạn chưa có món ăn nào</p>
        <button class="btn btn-primary" onclick="openMenuModal('add')" style="margin-top: 20px;">
          <i class="fas fa-plus"></i> Thêm món đầu tiên
        </button>
      </div>
    </div>
  </main>
  
  <!-- Menu Modal (Add/Edit) -->
  <div class="modal" id="menu-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modal-title"><i class="fas fa-utensils"></i> Thêm món mới</h3>
        <button class="close-btn" onclick="closeMenuModal()">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="menu-id">
        
        <div class="form-row">
          <div class="form-group">
            <label for="menu-code"><i class="fas fa-barcode"></i> Mã món *</label>
            <input type="text" id="menu-code" class="form-control" placeholder="VD: SP001">
            <div class="error-message" id="menu-code-error"></div>
          </div>
          <div class="form-group">
            <label for="menu-name"><i class="fas fa-utensils"></i> Tên món *</label>
            <input type="text" id="menu-name" class="form-control" placeholder="VD: Trà sữa trân châu">
            <div class="error-message" id="menu-name-error"></div>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="menu-category"><i class="fas fa-list"></i> Danh mục *</label>
            <select id="menu-category" class="form-control">
              <option value="">Đang tải danh mục...</option>
            </select>
            <div class="error-message" id="menu-category-error"></div>
          </div>
          <div class="form-group">
            <label for="menu-status"><i class="fas fa-power-off"></i> Trạng thái *</label>
            <select id="menu-status" class="form-control">
              <option value="active">Hoạt động</option>
              <option value="inactive">Ngừng bán</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label for="menu-base-price"><i class="fas fa-tag"></i> Giá gốc (VNĐ) *</label>
            <input type="number" id="menu-base-price" class="form-control" placeholder="VD: 35000" min="0">
            <div class="error-message" id="menu-base-price-error"></div>
          </div>
          <div class="form-group">
            <label for="menu-sale-price"><i class="fas fa-percent"></i> Giá khuyến mãi (VNĐ)</label>
            <input type="number" id="menu-sale-price" class="form-control" placeholder="VD: 30000" min="0">
            <div class="error-message" id="menu-sale-price-error"></div>
          </div>
        </div>
        
        <div class="form-group">
          <label><i class="fas fa-layer-group"></i> Phân hệ *</label>
          <div class="product-type-group">
            <div class="product-type-option active" id="main-product-option">
              <input type="radio" id="product-type-main" name="product-type" value="main" checked>
              <label for="product-type-main">Sản phẩm chính</label>
            </div>
            <div class="product-type-option" id="side-product-option">
              <input type="radio" id="product-type-side" name="product-type" value="side">
              <label for="product-type-side">Sản phẩm phụ</label>
            </div>
          </div>
          
          <div class="side-product-options" id="side-product-options">
            <div class="form-group">
              <label for="side-product-main"><i class="fas fa-link"></i> Áp dụng cho sản phẩm chính *</label>
              <select id="side-product-main" class="form-control">
                <option value="">Chọn sản phẩm chính</option>
                <!-- Main products will be loaded here -->
              </select>
              <div class="error-message" id="side-product-main-error"></div>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label><i class="fas fa-image"></i> Hình ảnh (tối đa 5 ảnh, mỗi ảnh tối đa 1MB)</label>
          <div class="uploadcare-container">
            <input type="hidden" role="uploadcare-uploader" id="uploadcare-widget" data-public-key="238c599562905655c2c8" data-images-only="true" />
          </div>
          <div class="image-preview-container" id="image-preview-container">
            <!-- Image previews will be added here -->
          </div>
          <div class="error-message" id="menu-images-error"></div>
        </div>
        
        <div class="form-group">
          <label><i class="fas fa-store"></i> Chi nhánh áp dụng *</label>
          <div class="branches-selection" id="branches-selection">
            <!-- Branches will be loaded here -->
          </div>
          <div class="error-message" id="menu-branches-error"></div>
        </div>
        
        <div class="form-group">
          <label for="menu-description"><i class="fas fa-align-left"></i> Mô tả sản phẩm</label>
          <textarea id="menu-description" class="form-control" rows="4" placeholder="Mô tả chi tiết về món ăn..."></textarea>
        </div>
      </div>
      <div class="form-footer">
        <button class="btn" onclick="closeMenuModal()">Hủy</button>
        <button class="btn btn-success" id="save-btn">Lưu</button>
      </div>
    </div>
  </div>
  
  <!-- Confirm Delete Modal -->
  <div class="modal confirm-modal" id="confirm-delete-modal">
    <div class="confirm-content">
      <h3><i class="fas fa-exclamation-triangle"></i> Xác nhận xóa</h3>
      <p>Bạn có chắc chắn muốn xóa món ăn này? Hành động này không thể hoàn tác.</p>
      <div class="confirm-buttons">
        <button class="btn" onclick="closeConfirmDeleteModal()">Hủy</button>
        <button class="btn btn-danger" id="confirm-delete-btn">Xóa</button>
      </div>
    </div>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  
  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBzAdWAVjD_NQP3uglLYOOFWUmDGsylsg0",
      authDomain: "foodiee-fcdc1.firebaseapp.com",
      databaseURL: "https://foodiee-fcdc1-default-rtdb.firebaseio.com",
      projectId: "foodiee-fcdc1",
      storageBucket: "foodiee-fcdc1.appspot.com",
      messagingSenderId: "993331259398",
      appId: "1:993331259398:web:2b922ef5e0519d5e237b87",
      measurementId: "G-PDT1VE8JL5"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    // DOM elements
    const menuList = document.getElementById('menu-list');
    const emptyMenuState = document.getElementById('empty-menu-state');
    const notificationBadge = document.getElementById('notification-badge');
    
    // Global variables
    let currentUser = null;
    let categories = [];
    let branches = [];
    let mainProducts = [];
    let currentImages = [];
    let uploadcareWidget = null;
    let currentEditingItem = null;
    let existingMenuItems = [];
    
    // Toggle sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('closed');
      localStorage.setItem('sidebarClosed', sidebar.classList.contains('closed'));
    }
    
    // Toggle branch submenu
    function toggleBranchSubmenu() {
      const submenu = document.getElementById('branch-submenu');
      const arrow = document.getElementById('branch-arrow');
      
      if (submenu.style.display === 'none' || submenu.style.display === '') {
        submenu.style.display = 'block';
        submenu.classList.add('show');
        arrow.classList.remove('fa-chevron-down');
        arrow.classList.add('fa-chevron-up');
      } else {
        submenu.style.display = 'none';
        submenu.classList.remove('show');
        arrow.classList.remove('fa-chevron-up');
        arrow.classList.add('fa-chevron-down');
      }
    }
    
    // Toggle notifications panel
    function toggleNotifications() {
      // Placeholder for notification functionality
      showToast('Tính năng thông báo đang được phát triển', 'warning');
    }

    // Show toast notification
    function showToast(message, type) {
      // Remove existing toasts
      const existingToasts = document.querySelectorAll('.toast');
      existingToasts.forEach(toast => toast.remove());
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        const uid = user.uid;
        const userRef = firebase.database().ref('users/' + uid);
        userRef.once('value').then((snapshot) => {
          const data = snapshot.val();
          if (!data) return;

          const avatarUrl = data.avatarUrl || '';
          const displayName = data.displayName || user.displayName || user.email.split('@')[0];

          // Set username
          const nameEl = document.getElementById('header-username');
          if (nameEl) nameEl.textContent = displayName;

          // Set avatar
          const avatarEl = document.getElementById('header-avatar');
          if (avatarEl) {
            if (avatarUrl) {
              avatarEl.style.backgroundImage = `url(${avatarUrl})`;
              avatarEl.style.backgroundSize = 'cover';
              avatarEl.style.backgroundPosition = 'center';
              avatarEl.textContent = '';
            } else {
              avatarEl.style.backgroundImage = '';
              avatarEl.textContent = displayName.charAt(0).toUpperCase();
            }
          }
          
          // Load data
          loadCategories();
          loadBranches();
          loadMenuItems();
        });
      } else {
        // Redirect to login if not authenticated
        window.location.href = 'index.html';
      }
    });
    
    // Load categories from Firebase
    function loadCategories() {
      if (!currentUser) return;

      database.ref(`users/${currentUser.uid}/category`).once('value')
        .then(snapshot => {
          categories = [];
          const data = snapshot.val();

          if (data) {
            Object.keys(data).forEach(key => {
              const category = data[key];

              if (category && category.type === "product") {
                category.id = key;
                categories.push(category);
              }
            });
          }

          // Sort categories
          categories.sort((a, b) => a.order - b.order);

          // Update dropdown
          const categorySelect = document.getElementById('menu-category');
          categorySelect.innerHTML = '<option value="">Chọn danh mục</option>';

          categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category.id;
            option.textContent = category.name;
            categorySelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Lỗi khi tải danh mục:', error);
          showToast('Lỗi khi tải danh mục sản phẩm', 'error');
        });
    }
    
    // Load branches from Firebase
    function loadBranches() {
      if (!currentUser) return;
      
      database.ref(`users/${currentUser.uid}/branches`).once('value')
        .then(snapshot => {
          branches = [];
          const data = snapshot.val();
          
          if (data) {
            Object.keys(data).forEach(key => {
              const branch = data[key];
              branch.id = key;
              branches.push(branch);
            });
          }
          
          // Update branches selection
          const branchesContainer = document.getElementById('branches-selection');
          branchesContainer.innerHTML = '';
          
          branches.forEach(branch => {
            const branchItem = document.createElement('div');
            branchItem.className = 'branch-item';
            branchItem.innerHTML = `
              <input type="checkbox" id="branch-${branch.id}" value="${branch.id}">
              <label for="branch-${branch.id}">${branch.name} (${branch.code})</label>
            `;
            branchesContainer.appendChild(branchItem);
          });
          
          // Add "Select All" option
          if (branches.length > 0) {
            const allItem = document.createElement('div');
            allItem.className = 'branch-item';
            allItem.innerHTML = `
              <input type="checkbox" id="branch-all" onchange="toggleAllBranches(this)">
              <label for="branch-all">Chọn tất cả chi nhánh</label>
            `;
            branchesContainer.prepend(allItem);
          }
        })
        .catch(error => {
          console.error('Error loading branches:', error);
          showToast('Lỗi khi tải chi nhánh', 'error');
        });
    }
    
    // Toggle all branches selection
    function toggleAllBranches(checkbox) {
      const branchCheckboxes = document.querySelectorAll('#branches-selection input[type="checkbox"]:not(#branch-all)');
      branchCheckboxes.forEach(branch => {
        branch.checked = checkbox.checked;
      });
    }
    
    // Load main products for side products
    function loadMainProducts() {
      if (!currentUser) return;
      
      database.ref(`users/${currentUser.uid}/menu`).orderByChild('productType').equalTo('main').once('value')
        .then(snapshot => {
          mainProducts = [];
          const data = snapshot.val();
          
          if (data) {
            Object.keys(data).forEach(key => {
              const product = data[key];
              product.id = key;
              mainProducts.push(product);
            });
          }
          
          // Update main products dropdown
          const mainSelect = document.getElementById('side-product-main');
          mainSelect.innerHTML = '<option value="">Chọn sản phẩm chính</option>';
          
          mainProducts.forEach(product => {
            const option = document.createElement('option');
            option.value = product.id;
            option.textContent = product.name;
            mainSelect.appendChild(option);
          });
        })
        .catch(error => {
          console.error('Error loading main products:', error);
        });
    }
    
    // Kiểm tra mã sản phẩm đã tồn tại
    function isCodeExists(code, excludeId = null) {
      return existingMenuItems.some(item => 
        item.code.toLowerCase() === code.toLowerCase() && 
        (!excludeId || item.id !== excludeId)
      );
    }

    // Kiểm tra tên sản phẩm đã tồn tại
    function isNameExists(name, excludeId = null) {
      return existingMenuItems.some(item => 
        item.name.toLowerCase() === name.toLowerCase() && 
        (!excludeId || item.id !== excludeId)
      );
    }

    // Hiển thị lỗi validation
    function showValidationError(inputId, message) {
      const errorDiv = document.getElementById(`${inputId}-error`);
      
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }
      
      const input = document.getElementById(inputId);
      if (input) {
        input.style.borderColor = 'var(--accent)';
      }
    }

    // Ẩn lỗi validation
    function hideValidationError(inputId) {
      const errorDiv = document.getElementById(`${inputId}-error`);
      
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
      
      const input = document.getElementById(inputId);
      if (input) {
        input.style.borderColor = '';
      }
    }

    // Kiểm tra mã sản phẩm real-time
    function checkMenuCode() {
      const code = document.getElementById('menu-code').value.trim();
      const isEditing = !!currentEditingItem;
      
      if (!code) {
        showValidationError('menu-code', 'Vui lòng nhập mã món');
        return false;
      }
      
      if (isCodeExists(code, isEditing ? currentEditingItem : null)) {
        showValidationError('menu-code', 'Mã món đã tồn tại');
        return false;
      }
      
      hideValidationError('menu-code');
      return true;
    }

    // Kiểm tra tên sản phẩm real-time
    function checkMenuName() {
      const name = document.getElementById('menu-name').value.trim();
      const isEditing = !!currentEditingItem;
      
      if (!name) {
        showValidationError('menu-name', 'Vui lòng nhập tên món');
        return false;
      }
      
      if (isNameExists(name, isEditing ? currentEditingItem : null)) {
        showValidationError('menu-name', 'Tên món đã tồn tại');
        return false;
      }
      
      hideValidationError('menu-name');
      return true;
    }

    // Validate form
    function validateForm() {
      let isValid = true;
      
      // Reset all errors
      document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
      });
      
      document.querySelectorAll('.form-control').forEach(input => {
        input.style.borderColor = '';
      });
      
      // Validate code
      if (!checkMenuCode()) isValid = false;
      
      // Validate name
      if (!checkMenuName()) isValid = false;
      
      // Validate category
      const categoryId = document.getElementById('menu-category').value;
      if (!categoryId) {
        showValidationError('menu-category', 'Vui lòng chọn danh mục');
        isValid = false;
      }
      
      // Validate base price
      const basePrice = parseInt(document.getElementById('menu-base-price').value) || 0;
      if (basePrice <= 0) {
        showValidationError('menu-base-price', 'Giá gốc phải lớn hơn 0');
        isValid = false;
      }
      
      // Validate sale price
      const salePrice = parseInt(document.getElementById('menu-sale-price').value) || 0;
      if (salePrice > 0 && salePrice >= basePrice) {
        showValidationError('menu-sale-price', 'Giá khuyến mãi phải nhỏ hơn giá gốc');
        isValid = false;
      }
      
      // Validate product type
      const productType = document.querySelector('input[name="product-type"]:checked').value;
      if (productType === 'side') {
        const mainProductId = document.getElementById('side-product-main').value;
        if (!mainProductId) {
          showValidationError('side-product-main', 'Vui lòng chọn sản phẩm chính');
          isValid = false;
        }
      }
      
      // Validate branches
      const selectedBranches = document.querySelectorAll('#branches-selection input[type="checkbox"]:checked:not(#branch-all)');
      if (selectedBranches.length === 0) {
        showValidationError('menu-branches', 'Vui lòng chọn ít nhất một chi nhánh');
        isValid = false;
      }
      
      // Validate images
      if (currentImages.length === 0) {
        showValidationError('menu-images', 'Vui lòng tải lên ít nhất một ảnh');
        isValid = false;
      }
      
      return isValid;
    }

    // Open menu modal (add or edit)
    function openMenuModal(mode, itemId = null) {
      const modal = document.getElementById('menu-modal');
      const title = document.getElementById('modal-title');
      const saveBtn = document.getElementById('save-btn');
      
      if (mode === 'add') {
        title.innerHTML = '<i class="fas fa-plus"></i> Thêm món mới';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Thêm món';
        saveBtn.onclick = saveMenuItem;
        currentEditingItem = null;
      } else if (mode === 'edit') {
        title.innerHTML = '<i class="fas fa-edit"></i> Sửa món ăn';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Cập nhật';
        saveBtn.onclick = updateMenuItem;
        loadMenuItemForEdit(itemId);
      }
      
      modal.style.display = 'flex';
      
      // Reset form
      document.getElementById('menu-code').value = '';
      document.getElementById('menu-code').disabled = (mode === 'edit');
      document.getElementById('menu-name').value = '';
      document.getElementById('menu-base-price').value = '';
      document.getElementById('menu-sale-price').value = '';
      document.getElementById('menu-description').value = '';
      document.getElementById('menu-status').value = 'active';
      document.getElementById('menu-category').selectedIndex = 0;
      document.getElementById('side-product-main').selectedIndex = 0;
      document.getElementById('product-type-main').checked = true;
      document.getElementById('side-product-options').style.display = 'none';
      
      // Xóa các thông báo lỗi cũ
      document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
      });
      
      document.querySelectorAll('.form-control').forEach(input => {
        input.style.borderColor = '';
      });
      
      // Reset product type UI
      document.getElementById('main-product-option').classList.add('active');
      document.getElementById('side-product-option').classList.remove('active');
      
      // Clear images
      currentImages = [];
      updateImagePreviews();
      
      // Uncheck all branches
      const branchCheckboxes = document.querySelectorAll('#branches-selection input[type="checkbox"]');
      branchCheckboxes.forEach(branch => {
        branch.checked = false;
      });
      
      // Initialize Uploadcare widget
      if (!uploadcareWidget) {
        const widgetElement = document.getElementById('uploadcare-widget');
        uploadcareWidget = uploadcare.Widget(widgetElement);
        
        uploadcareWidget.onChange(function(file) {
          if (file) {
            file.done(function(info) {
              if (currentImages.length >= 5) {
                showToast('Bạn chỉ có thể tải lên tối đa 5 ảnh', 'warning');
                return;
              }
              
              // Check file size (1MB = 1000000 bytes)
              if (info.size > 1000000) {
                showToast('Ảnh không được vượt quá 1MB', 'error');
                return;
              }
              
              currentImages.push(info.cdnUrl);
              updateImagePreviews();
            });
          }
        });
      } else {
        uploadcareWidget.value(null);
      }
      
      // Load main products for side products
      loadMainProducts();
      
      // Add event listeners for product type
      document.getElementById('main-product-option').addEventListener('click', function() {
        document.getElementById('product-type-main').checked = true;
        document.getElementById('side-product-options').style.display = 'none';
        this.classList.add('active');
        document.getElementById('side-product-option').classList.remove('active');
      });
      
      document.getElementById('side-product-option').addEventListener('click', function() {
        document.getElementById('product-type-side').checked = true;
        document.getElementById('side-product-options').style.display = 'block';
        this.classList.add('active');
        document.getElementById('main-product-option').classList.remove('active');
      });
      
      // Thêm sự kiện kiểm tra real-time
      document.getElementById('menu-code').addEventListener('input', checkMenuCode);
      document.getElementById('menu-code').addEventListener('blur', checkMenuCode);
      document.getElementById('menu-name').addEventListener('input', checkMenuName);
      document.getElementById('menu-name').addEventListener('blur', checkMenuName);
    }
    
    // Close menu modal
    function closeMenuModal() {
      document.getElementById('menu-modal').style.display = 'none';
    }
    
    // Update image previews
    function updateImagePreviews() {
      const container = document.getElementById('image-preview-container');
      container.innerHTML = '';
      
      currentImages.forEach((image, index) => {
        const preview = document.createElement('div');
        preview.className = 'image-preview';
        preview.style.backgroundImage = `url(${image})`;
        
        const removeBtn = document.createElement('div');
        removeBtn.className = 'remove-image';
        removeBtn.innerHTML = '&times;';
        removeBtn.onclick = () => removeImage(index);
        
        preview.appendChild(removeBtn);
        container.appendChild(preview);
      });
    }
    
    // Remove image
    function removeImage(index) {
      currentImages.splice(index, 1);
      updateImagePreviews();
    }
    
    // Save menu item to Firebase
    function saveMenuItem() {
      if (!currentUser) {
        showToast('Bạn chưa đăng nhập!', 'error');
        return;
      }
      
      // Validate form
      if (!validateForm()) return;
      
      // Get form values
      const code = document.getElementById('menu-code').value.trim();
      const name = document.getElementById('menu-name').value.trim();
      const categoryId = document.getElementById('menu-category').value;
      const basePrice = parseInt(document.getElementById('menu-base-price').value) || 0;
      const salePrice = parseInt(document.getElementById('menu-sale-price').value) || 0;
      const productType = document.querySelector('input[name="product-type"]:checked').value;
      const mainProductId = document.getElementById('side-product-main').value;
      const description = document.getElementById('menu-description').value.trim();
      const status = document.getElementById('menu-status').value;
      
      // Get selected branches
      const selectedBranches = [];
      document.querySelectorAll('#branches-selection input[type="checkbox"]:checked:not(#branch-all)').forEach(checkbox => {
        selectedBranches.push(checkbox.value);
      });
      
      // Find category name
      const category = categories.find(c => c.id === categoryId);
      const categoryName = category ? category.name : '';
      
      // Create menu item data
      const menuItem = {
        code: code,
        name: name,
        categoryId: categoryId,
        categoryName: categoryName,
        basePrice: basePrice,
        salePrice: salePrice,
        productType: productType,
        mainProductId: productType === 'side' ? mainProductId : null,
        images: currentImages,
        branches: selectedBranches,
        description: description,
        status: status,
        createdAt: new Date().toISOString()
      };
      
      // Save to Firebase
      const menuRef = database.ref(`users/${currentUser.uid}/menu/${code}`);
      menuRef.set(menuItem)
        .then(() => {
          closeMenuModal();
          loadMenuItems();
          showToast('Thêm món thành công!', 'success');
        })
        .catch(error => {
          console.error('Error saving menu item:', error);
          showToast('Có lỗi xảy ra: ' + error.message, 'error');
        });
    }
    
    // Load menu item for editing
    function loadMenuItemForEdit(code) {
      if (!currentUser) return;
      
      database.ref(`users/${currentUser.uid}/menu/${code}`).once('value')
        .then(snapshot => {
          const menuItem = snapshot.val();
          if (!menuItem) return;
          
          currentEditingItem = code;
          
          // Fill form
          document.getElementById('menu-code').value = menuItem.code;
          document.getElementById('menu-code').disabled = true;
          document.getElementById('menu-name').value = menuItem.name;
          document.getElementById('menu-category').value = menuItem.categoryId;
          document.getElementById('menu-status').value = menuItem.status;
          document.getElementById('menu-base-price').value = menuItem.basePrice;
          document.getElementById('menu-sale-price').value = menuItem.salePrice;
          document.getElementById('menu-description').value = menuItem.description || '';
          
          // Set product type
          if (menuItem.productType === 'side') {
            document.getElementById('product-type-side').checked = true;
            document.getElementById('side-product-options').style.display = 'block';
            document.getElementById('side-product-main').value = menuItem.mainProductId || '';
            document.getElementById('main-product-option').classList.remove('active');
            document.getElementById('side-product-option').classList.add('active');
          } else {
            document.getElementById('product-type-main').checked = true;
            document.getElementById('side-product-options').style.display = 'none';
            document.getElementById('main-product-option').classList.add('active');
            document.getElementById('side-product-option').classList.remove('active');
          }
          
          // Set images
          currentImages = menuItem.images || [];
          updateImagePreviews();
          
          // Set branches
          const branchCheckboxes = document.querySelectorAll('#branches-selection input[type="checkbox"]:not(#branch-all)');
          branchCheckboxes.forEach(checkbox => {
            checkbox.checked = menuItem.branches && menuItem.branches.includes(checkbox.value);
          });
        })
        .catch(error => {
          console.error('Error loading menu item:', error);
          showToast('Lỗi khi tải dữ liệu món ăn', 'error');
        });
    }
    
    // Update menu item
    function updateMenuItem() {
      if (!currentUser || !currentEditingItem) {
        showToast('Không có món ăn nào được chọn để sửa', 'error');
        return;
      }
      
      // Validate form
      if (!validateForm()) return;
      
      // Get form values
      const name = document.getElementById('menu-name').value.trim();
      const categoryId = document.getElementById('menu-category').value;
      const basePrice = parseInt(document.getElementById('menu-base-price').value) || 0;
      const salePrice = parseInt(document.getElementById('menu-sale-price').value) || 0;
      const productType = document.querySelector('input[name="product-type"]:checked').value;
      const mainProductId = document.getElementById('side-product-main').value;
      const description = document.getElementById('menu-description').value.trim();
      const status = document.getElementById('menu-status').value;
      
      // Get selected branches
      const selectedBranches = [];
      document.querySelectorAll('#branches-selection input[type="checkbox"]:checked:not(#branch-all)').forEach(checkbox => {
        selectedBranches.push(checkbox.value);
      });
      
      // Find category name
      const category = categories.find(c => c.id === categoryId);
      const categoryName = category ? category.name : '';
      
      // Create updated menu item data
      const menuItem = {
        name: name,
        categoryId: categoryId,
        categoryName: categoryName,
        basePrice: basePrice,
        salePrice: salePrice,
        productType: productType,
        mainProductId: productType === 'side' ? mainProductId : null,
        images: currentImages,
        branches: selectedBranches,
        description: description,
        status: status
      };
      
      // Update to Firebase
      const menuRef = database.ref(`users/${currentUser.uid}/menu/${currentEditingItem}`);
      menuRef.update(menuItem)
        .then(() => {
          closeMenuModal();
          loadMenuItems();
          showToast('Cập nhật món thành công!', 'success');
        })
        .catch(error => {
          console.error('Error updating menu item:', error);
          showToast('Có lỗi xảy ra: ' + error.message, 'error');
        });
    }
    
    // Toggle menu item status
    function toggleMenuItemStatus(code, currentStatus) {
      if (!currentUser) return;
      
      const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
      const statusText = newStatus === 'active' ? 'kích hoạt' : 'vô hiệu hóa';
      
      const ref = database.ref(`users/${currentUser.uid}/menu/${code}`);
      
      ref.update({ status: newStatus })
        .then(() => {
          loadMenuItems();
          showToast(`Đã ${statusText} món ăn thành công!`, 'success');
        })
        .catch(error => {
          console.error('Lỗi khi cập nhật trạng thái:', error);
          showToast('Có lỗi xảy ra khi thay đổi trạng thái', 'error');
        });
    }
    
    // Open confirm delete modal
    function openConfirmDeleteModal(code) {
      const modal = document.getElementById('confirm-delete-modal');
      const confirmBtn = document.getElementById('confirm-delete-btn');
      
      confirmBtn.onclick = function() {
        deleteMenuItem(code);
      };
      
      modal.style.display = 'flex';
    }
    
    // Close confirm delete modal
    function closeConfirmDeleteModal() {
      document.getElementById('confirm-delete-modal').style.display = 'none';
    }
    
    // Delete menu item
    function deleteMenuItem(code) {
      if (!currentUser) return;
      
      database.ref(`users/${currentUser.uid}/menu/${code}`).remove()
        .then(() => {
          closeConfirmDeleteModal();
          loadMenuItems();
          showToast('Đã xóa món ăn thành công!', 'success');
        })
        .catch(error => {
          console.error('Error deleting menu item:', error);
          showToast('Có lỗi xảy ra khi xóa món ăn', 'error');
        });
    }
    
    // Load menu items from Firebase
    function loadMenuItems() {
      if (!currentUser) return;
      
      database.ref(`users/${currentUser.uid}/menu`).once('value')
        .then(snapshot => {
          const data = snapshot.val();
          existingMenuItems = []; // Reset danh sách sản phẩm hiện có
          
          if (data) {
            Object.keys(data).forEach(key => {
              const item = data[key];
              item.id = key;
              existingMenuItems.push(item);
            });
          }
          
          renderMenuItems(data);
          
          // Show empty state if no items
          if (!data || Object.keys(data).length === 0) {
            emptyMenuState.style.display = 'block';
            menuList.innerHTML = '';
          } else {
            emptyMenuState.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error loading menu items:', error);
          showToast('Lỗi khi tải dữ liệu menu', 'error');
        });
    }
    
    // Render menu items to table
    function renderMenuItems(data) {
      menuList.innerHTML = '';
      
      if (!data) return;
      
      Object.keys(data).forEach(key => {
        const item = data[key];
        
        // Determine display price
        let displayPrice = item.basePrice;
        if (item.salePrice > 0 && item.salePrice < item.basePrice) {
          displayPrice = item.salePrice;
        }
        
        // Format price
        const formattedPrice = new Intl.NumberFormat('vi-VN').format(displayPrice);
        
        // Status badge
        const statusBadge = item.status === 'active' ? 
          '<span class="status-badge status-active">Hoạt động</span>' : 
          '<span class="status-badge status-inactive">Ngừng bán</span>';
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item.code}</td>
          <td>${item.name}</td>
          <td>${item.productType === 'main' ? 'Sản phẩm chính' : 'Sản phẩm phụ'}</td>
          <td>${formattedPrice} VNĐ</td>
          <td>${statusBadge}</td>
          <td>
            ${item.images && item.images.length > 0 ? 
              `<div class="image-preview" style="width: 60px; height: 40px; background-image: url(${item.images[0]})"></div>` : 
              '<span>Chưa có ảnh</span>'}
          </td>
          <td class="action-buttons">
            <button class="action-btn edit" title="Chỉnh sửa" onclick="openMenuModal('edit', '${item.code}')">
              <i class="fas fa-edit"></i>
            </button>
            ${item.status === 'active' ? 
              `<button class="action-btn disable" title="Vô hiệu hóa" onclick="toggleMenuItemStatus('${item.code}', '${item.status}')">
                <i class="fas fa-ban"></i>
              </button>` : 
              `<button class="action-btn enable" title="Kích hoạt" onclick="toggleMenuItemStatus('${item.code}', '${item.status}')">
                <i class="fas fa-check"></i>
              </button>`}
            <button class="action-btn delete ${item.status === 'active' ? 'disabled' : ''}" 
                title="${item.status === 'active' ? 'Chỉ xóa được khi đang ngừng bán' : 'Xóa'}" 
                onclick="${item.status === 'inactive' ? `openConfirmDeleteModal('${item.code}')` : 'return false;'}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        menuList.appendChild(row);
      });
    }
    
    // Filter menu items
    function filterMenu() {
      const searchTerm = document.getElementById('menu-search').value.toLowerCase();
      const rows = menuList.getElementsByTagName('tr');
      
      for (let i = 0; i < rows.length; i++) {
        const code = rows[i].cells[0].textContent.toLowerCase();
        const name = rows[i].cells[1].textContent.toLowerCase();
        
        if (code.includes(searchTerm) || name.includes(searchTerm)) {
          rows[i].style.display = '';
        } else {
          rows[i].style.display = 'none';
        }
      }
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      if (localStorage.getItem('sidebarClosed') === 'true') {
        document.getElementById('sidebar').classList.add('closed');
      }
    });
  </script>
</body>
</html>