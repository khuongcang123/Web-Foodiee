<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Trang chủ - Foodiee Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
      --warning: #f39c12;
      --gray: #95a5a6;
      --sidebar-width: 250px;
      --sidebar-collapsed: 70px;
      --transition-speed: 0.3s;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      overflow-x: hidden;
      display: flex;
      min-height: 100vh;
    }

    /* Header */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 2px solid var(--secondary);
      margin-bottom: 30px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .notification-icon {
      position: relative;
      cursor: pointer;
      font-size: 1.3rem;
      color: var(--primary);
      transition: transform 0.3s;
    }

    .notification-icon:hover {
      transform: scale(1.1);
      color: var(--accent);
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent);
      color: white;
      font-size: 0.7rem;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      background-size: cover;
      background-position: center;
    }

    .user-name {
      font-weight: 500;
      color: var(--primary);
    }

    /* Sidebar */
    .sidebar {
      background: linear-gradient(135deg, var(--primary), #1a2530);
      color: white;
      width: var(--sidebar-width);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      overflow-y: auto;
      transition: all var(--transition-speed) ease;
      box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar.closed {
      width: var(--sidebar-collapsed);
    }

    .toggle-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 100%;
      padding: 15px;
      cursor: pointer;
      text-align: left;
      display: flex;
      align-items: center;
      transition: background 0.3s;
    }

    .toggle-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .toggle-btn i {
      font-size: 1.5rem;
      margin-right: 15px;
    }

    .sidebar.closed .toggle-btn i {
      margin-right: 0;
    }

    .nav-menu {
      padding: 15px 0;
    }

    .nav-menu ul {
      list-style: none;
    }

    .nav-menu ul li {
      position: relative;
    }

    .nav-menu ul li a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .nav-menu ul li a:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-menu ul li a.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left: 4px solid var(--accent);
    }

    .nav-menu ul li a i {
      font-size: 1.2rem;
      min-width: 30px;
      text-align: center;
      transition: transform 0.3s;
    }

    .link-text {
      margin-left: 15px;
      transition: opacity var(--transition-speed), margin var(--transition-speed);
      white-space: nowrap;
    }

    .sidebar.closed .link-text {
      opacity: 0;
      margin-left: -10px;
      pointer-events: none;
    }

    /* Submenu */
    .submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      background: rgba(0, 0, 0, 0.15);
      padding-left: 0;
    }

    .submenu.show {
      max-height: 500px;
    }

    .submenu li a {
      padding: 12px 20px 12px 60px !important;
      font-size: 0.9rem;
    }

    .submenu li a i {
      font-size: 0.9rem;
    }

    /* Fix submenu khi sidebar đóng */
    .sidebar.closed .submenu {
      position: absolute;
      left: 100%;
      top: 0;
      min-width: 200px;
      background: #2c3e50;
      border-radius: 0 8px 8px 0;
      box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    .sidebar.closed .submenu.show {
      max-height: none;
      display: block;
    }

    .sidebar.closed .submenu li a {
      padding: 12px 15px !important;
    }

    .sidebar.closed .submenu .link-text {
      opacity: 1;
      margin-left: 10px;
      pointer-events: auto;
    }

    /* Main content */
    main {
      flex: 1;
      padding: 30px;
      margin-left: var(--sidebar-width);
      transition: margin var(--transition-speed);
      overflow-y: auto;
    }

    .sidebar.closed + main {
      margin-left: var(--sidebar-collapsed);
    }

    h1 {
      color: var(--primary);
      font-weight: 600;
    }
    
    /* Voucher Management Styles */
    .voucher-management {
      margin-top: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      overflow: hidden;
    }
    
    .voucher-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
    }
    
    .add-voucher-btn {
      background: var(--success);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      transition: background 0.3s;
    }
    
    .add-voucher-btn:hover {
      background: #27ae60;
    }
    
    .voucher-controls {
      padding: 15px 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #eee;
      display: flex;
      gap: 15px;
    }
    
    .search-box {
      flex: 1;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
    }
    
    .voucher-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .voucher-table th {
      background: var(--light);
      padding: 15px;
      text-align: left;
      color: var(--primary);
      font-weight: 600;
      border-bottom: 2px solid #ddd;
    }
    
    .voucher-table td {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .voucher-table tr:hover {
      background: #f9f9f9;
    }
    
    .status-badge {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
      display: inline-block;
      min-width: 100px;
      text-align: center;
    }
    
    .status-active {
      background: rgba(46, 204, 113, 0.15);
      color: var(--success);
    }
    
    .status-inactive {
      background: rgba(231, 76, 60, 0.15);
      color: var(--accent);
    }
    
    .status-expired {
      background: rgba(149, 165, 166, 0.15);
      color: var(--gray);
    }
    
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      padding: 5px 10px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .action-btn.edit {
      background: rgba(52, 152, 219, 0.15);
      color: var(--secondary);
    }
    
    .action-btn.edit:hover {
      background: var(--secondary);
      color: white;
    }
    
    .action-btn.delete {
      background: rgba(231, 76, 60, 0.15);
      color: var(--accent);
    }
    
    .action-btn.delete:hover {
      background: var(--accent);
      color: white;
    }

    .action-btn.disable {
      background: rgba(243, 156, 18, 0.15);
      color: var(--warning);
    }
    
    .action-btn.disable:hover {
      background: var(--warning);
      color: white;
    }
    
    .action-btn.enable {
      background: rgba(46, 204, 113, 0.15);
      color: var(--success);
    }
    
    .action-btn.enable:hover {
      background: var(--success);
      color: white;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      overflow: auto;
    }
    
    .modal-content {
      background: white;
      width: 90%;
      max-width: 700px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      animation: modalAppear 0.3s ease;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
    }
    
    @keyframes modalAppear {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .modal-header {
      padding: 20px;
      background: var(--primary);
      color: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h2 {
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5rem;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.3s;
    }
    
    .close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }
    
    .modal-body {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .form-control {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
      transition: all 0.3s;
    }
    
    .form-control:focus {
      outline: none;
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .form-col {
      flex: 1;
    }
    
    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 8px;
    }
    
    .radio-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-group {
      margin-top: 10px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .select-all {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .product-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 5px;
      padding: 10px;
    }
    
    .modal-footer {
      padding: 20px;
      display: flex;
      justify-content: flex-end;
      gap: 15px;
      background: #f9f9f9;
      border-top: 1px solid #eee;
    }
    
    .btn {
      padding: 10px 25px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-cancel {
      background: #eee;
      color: #666;
    }
    
    .btn-cancel:hover {
      background: #e0e0e0;
    }
    
    .btn-save {
      background: var(--success);
      color: white;
    }
    
    .btn-save:hover {
      background: #27ae60;
    }
    
    .error-message {
      color: var(--accent);
      font-size: 0.85rem;
      margin-top: 5px;
      display: none;
    }
    
    /* Empty state */
    .empty-state {
      padding: 30px;
      text-align: center;
      color: var(--gray);
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 15px;
      color: #e0e0e0;
    }
    
    .empty-state p {
      font-size: 18px;
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 8px;
      color: white;
      font-weight: 500;
      z-index: 3000;
      box-shadow: 0 5px 15px rgba(0,0,0,0.15);
      animation: toastSlideIn 0.3s ease-out;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .toast.error {
      background: var(--accent);
    }
    
    .toast.success {
      background: var(--success);
    }
    
    .toast.warning {
      background: var(--warning);
    }
    
    @keyframes toastSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* Confirm modal */
    .confirm-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    
    .confirm-content {
      background: white;
      border-radius: 10px;
      padding: 25px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }
    
    .confirm-content h3 {
      margin-bottom: 15px;
      color: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .confirm-content p {
      margin-bottom: 25px;
      color: var(--gray);
    }
    
    .confirm-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    /* Responsive */
    @media (max-width: 992px) {
      .sidebar {
        width: var(--sidebar-collapsed);
      }
      
      .sidebar:not(.closed) {
        width: var(--sidebar-width);
      }
      
      main {
        margin-left: var(--sidebar-collapsed);
      }
      
      .sidebar:not(.closed) + main {
        margin-left: var(--sidebar-width);
      }
      
      .voucher-table {
        display: block;
        overflow-x: auto;
      }
    }

    @media (max-width: 768px) {
      .voucher-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .form-row {
        flex-direction: column;
        gap: 20px;
      }
      
      .action-buttons {
        flex-wrap: wrap;
      }
      
      .modal-content {
        width: 95%;
      }
      
      .radio-group {
        flex-direction: column;
        gap: 10px;
      }
      
      .confirm-buttons {
        flex-direction: column;
      }
    }

    @media (max-width: 480px) {
      .main-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .header-right {
        align-self: flex-end;
      }
      
      .modal-footer {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
      
      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>
    <nav class="nav-menu">
      <ul>
        <li><a href="tongquan.html"><i class="fas fa-chart-line"></i><span class="link-text">Tổng quan</span></a></li>
        <li><a href="quanlychinhanh.html"><i class="fas fa-building"></i><span class="link-text">Quản lý chi nhánh</span></a></li>
        <li>
          <a href="#" onclick="toggleBranchSubmenu()">
            <i class="fas fa-store-alt"></i>
            <span class="link-text">Quản lý nhà hàng</span>
            <i id="branch-arrow" class="fas fa-chevron-down" style="float: right;"></i>
          </a>
          <ul class="submenu" id="branch-submenu" style="display: none; padding-left: 20px;"></ul>
        </li>
        <li><a href="quanlynhanvien.html"><i class="fas fa-user-friends"></i><span class="link-text">Quản lý nhân viên</span></a></li>
        <li><a href="quanlydanhmuc.html"><i class="fas fa-list-alt"></i><span class="link-text">Quản lý danh mục</span></a></li>
        <li><a href="quanlymenu.html"><i class="fas fa-utensils"></i><span class="link-text">Quản lý menu</span></a></li>
        <li><a href="quanlykhachhang.html"><i class="fas fa-user"></i><span class="link-text">Quản lý khách hàng</span></a></li>  
        <li><a href="quanlyvoucher.html" class="active"><i class="fas fa-ticket-alt"></i><span class="link-text">Quản lý voucher</span></a></li>
        <li><a href="setting.html"><i class="fas fa-cogs"></i><span class="link-text">Cài đặt</span></a></li>
      </ul>
    </nav>
  </div>
  
  <main>
    <div class="main-header">
      <h1>Trang Quản Lý Voucher</h1>
      <div class="header-right">
        <div class="notification-icon" onclick="toggleNotifications()">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notification-badge">0</span>
        </div>
        <div class="user-profile">
          <div class="avatar" id="header-avatar">A</div>
          <span class="user-name" id="header-username">Admin</span>
        </div>
      </div>
    </div>
    
    <div class="voucher-management">
      <div class="voucher-header">
        <h2>Danh sách Voucher</h2>
        <button class="add-voucher-btn" id="addVoucherBtn">
          <i class="fas fa-plus"></i> Thêm voucher mới
        </button>
      </div>
      
      <div class="voucher-controls">
        <div class="search-box">
          <i class="fas fa-search"></i>
          <input type="text" id="voucher-search" placeholder="Tìm kiếm theo mã, tên..." oninput="filterVouchers()">
        </div>
      </div>
      
      <table class="voucher-table">
        <thead>
          <tr>
            <th>Mã voucher</th>
            <th>Tên voucher</th>
            <th>Đã sử dụng</th>
            <th>Loại giảm</th>
            <th>Giá trị giảm</th>
            <th>Ngày hết hạn</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody id="voucherList">
          <tr>
            <td colspan="8" style="text-align: center; padding: 30px;">
              <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
            </td>
          </tr>
        </tbody>
      </table>
      
      <div id="empty-voucher-state" class="empty-state" style="display: none;">
        <i class="fas fa-ticket-alt"></i>
        <p>Bạn chưa có voucher nào</p>
        <button class="add-voucher-btn" onclick="openVoucherModal('add')" style="margin-top: 20px;">
          <i class="fas fa-plus"></i> Thêm voucher đầu tiên
        </button>
      </div>
    </div>
  </main>
  
  <!-- Modal Thêm/Sửa Voucher -->
  <div class="modal" id="voucherModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modalTitle"><i class="fas fa-ticket-alt"></i> Thêm Voucher Mới</h2>
        <button class="close-btn" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="voucherForm">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="voucherCode"><i class="fas fa-barcode"></i> Mã Voucher *</label>
                <input type="text" id="voucherCode" class="form-control" placeholder="Nhập mã voucher" maxlength="20">
                <div class="error-message" id="codeError">Mã voucher không hợp lệ</div>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="voucherName"><i class="fas fa-ticket-alt"></i> Tên Voucher *</label>
                <input type="text" id="voucherName" class="form-control" placeholder="Nhập tên voucher">
                <div class="error-message" id="nameError">Vui lòng nhập tên voucher</div>
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label><i class="fas fa-percent"></i> Loại giảm giá *</label>
                <div class="radio-group">
                  <div class="radio-item">
                    <input type="radio" id="discountPercent" name="discountType" value="percent" checked>
                    <label for="discountPercent">Giảm theo phần trăm</label>
                  </div>
                  <div class="radio-item">
                    <input type="radio" id="discountAmount" name="discountType" value="amount">
                    <label for="discountAmount">Giảm theo số tiền</label>
                  </div>
                </div>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="discountValue"><i class="fas fa-tag"></i> Giá trị giảm *</label>
                <input type="number" id="discountValue" class="form-control" placeholder="Nhập giá trị" min="1">
                <div class="error-message" id="valueError">Giá trị không hợp lệ</div>
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="minOrder"><i class="fas fa-money-bill-wave"></i> Đơn tối thiểu (VND)</label>
                <input type="number" id="minOrder" class="form-control" placeholder="Nhập đơn tối thiểu" min="0">
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="maxDiscount"><i class="fas fa-wallet"></i> Giá trị giảm tối đa (VND)</label>
                <input type="number" id="maxDiscount" class="form-control" placeholder="Nhập giá trị tối đa" min="0">
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="startDate"><i class="fas fa-calendar-alt"></i> Ngày bắt đầu *</label>
                <input type="date" id="startDate" class="form-control">
                <div class="error-message" id="startDateError">Vui lòng chọn ngày bắt đầu</div>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="endDate"><i class="fas fa-calendar-times"></i> Ngày kết thúc *</label>
                <input type="date" id="endDate" class="form-control">
                <div class="error-message" id="endDateError">Vui lòng chọn ngày kết thúc</div>
              </div>
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="totalQuantity"><i class="fas fa-boxes"></i> Tổng số lượng *</label>
                <input type="number" id="totalQuantity" class="form-control" placeholder="Nhập tổng số lượng" min="1">
                <div class="error-message" id="quantityError">Vui lòng nhập số lượng hợp lệ</div>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="perUserLimit"><i class="fas fa-user"></i> Số lượng dùng cho mỗi khách *</label>
                <input type="number" id="perUserLimit" class="form-control" placeholder="Nhập số lượng" min="1">
                <div class="error-message" id="limitError">Vui lòng nhập số lượng hợp lệ</div>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-utensils"></i> Sản phẩm áp dụng</label>
            <div class="select-all">
              <input type="checkbox" id="selectAllProducts">
              <label for="selectAllProducts">Chọn tất cả sản phẩm</label>
            </div>
            <div class="product-list" id="productList">
              <!-- Danh sách sản phẩm sẽ được thêm tự động -->
              <div class="text-center py-3">
                <i class="fas fa-spinner fa-spin"></i> Đang tải sản phẩm...
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label><i class="fas fa-power-off"></i> Trạng thái *</label>
            <div class="radio-group">
              <div class="radio-item">
                <input type="radio" id="statusActive" name="status" value="active" checked>
                <label for="statusActive">Hoạt động</label>
              </div>
              <div class="radio-item">
                <input type="radio" id="statusInactive" name="status" value="inactive">
                <label for="statusInactive">Ngừng hoạt động</label>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" id="cancelBtn"><i class="fas fa-times"></i> Hủy bỏ</button>
        <button class="btn btn-save" id="saveVoucherBtn"><i class="fas fa-save"></i> Lưu voucher</button>
      </div>
    </div>
  </div>
  
  <!-- Confirm Delete Modal -->
  <div class="modal confirm-modal" id="confirm-delete-modal">
    <div class="confirm-content">
      <h3><i class="fas fa-exclamation-triangle"></i> Xác nhận xóa</h3>
      <p>Bạn có chắc chắn muốn xóa voucher này? Hành động này không thể hoàn tác.</p>
      <div class="confirm-buttons">
        <button class="btn btn-cancel" onclick="closeConfirmDeleteModal()">Hủy</button>
        <button class="btn btn-danger" id="confirm-delete-btn"><i class="fas fa-trash"></i> Xóa</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBzAdWAVjD_NQP3uglLYOOFWUmDGsylsg0",
      authDomain: "foodiee-fcdc1.firebaseapp.com",
      databaseURL: "https://foodiee-fcdc1-default-rtdb.firebaseio.com",
      projectId: "foodiee-fcdc1",
      storageBucket: "foodiee-fcdc1.appspot.com",
      messagingSenderId: "993331259398",
      appId: "1:993331259398:web:2b922ef5e0519d5e237b87",
      measurementId: "G-PDT1VE8JL5"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    // Biến toàn cục
    let currentUser = null;
    let editingVoucherId = null;
    let products = [];
    
    // DOM Elements
    const addVoucherBtn = document.getElementById('addVoucherBtn');
    const voucherModal = document.getElementById('voucherModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveVoucherBtn = document.getElementById('saveVoucherBtn');
    const voucherForm = document.getElementById('voucherForm');
    const modalTitle = document.getElementById('modalTitle');
    const voucherList = document.getElementById('voucherList');
    const selectAllProducts = document.getElementById('selectAllProducts');
    const productList = document.getElementById('productList');
    const emptyVoucherState = document.getElementById('empty-voucher-state');
    
    // Lắng nghe trạng thái đăng nhập
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        document.getElementById('header-username').textContent = user.displayName || user.email.split('@')[0];
        document.getElementById('header-avatar').textContent = user.displayName?.charAt(0) || user.email.charAt(0);
        loadVouchers();
      } else {
        // Redirect to login if not authenticated
        window.location.href = 'index.html';
      }
    });
    
    // Tải danh sách sản phẩm từ Firebase
    function loadProducts() {
      if (!currentUser) return;
      
      const productsRef = database.ref(`users/${currentUser.uid}/menu`);
      
      productsRef.once('value')
        .then(snapshot => {
          products = [];
          const data = snapshot.val();
          productList.innerHTML = '';
          
          if (data) {
            Object.keys(data).forEach(key => {
              const product = data[key];
              products.push({
                id: key,
                name: product.name,
                code: product.code
              });
              
              const item = document.createElement('div');
              item.className = 'checkbox-item';
              item.innerHTML = `
                <input type="checkbox" id="${key}" value="${key}">
                <label for="${key}">${product.name} (${product.code})</label>
              `;
              productList.appendChild(item);
            });
            
            // Thêm sự kiện chọn tất cả
            selectAllProducts.addEventListener('change', (e) => {
              const checkboxes = productList.querySelectorAll('input[type="checkbox"]');
              checkboxes.forEach(checkbox => {
                checkbox.checked = e.target.checked;
              });
            });
          } else {
            productList.innerHTML = '<p>Không có sản phẩm nào</p>';
          }
        })
        .catch(error => {
          console.error('Error loading products:', error);
          productList.innerHTML = '<p>Lỗi khi tải sản phẩm</p>';
        });
    }
    
    // Mở modal thêm voucher
    function openVoucherModal(mode, voucherId = null) {
      const modal = document.getElementById('voucherModal');
      const title = document.getElementById('modalTitle');
      const saveBtn = document.getElementById('saveVoucherBtn');
      
      if (mode === 'add') {
        title.innerHTML = '<i class="fas fa-plus"></i> Thêm Voucher Mới';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Thêm voucher';
        saveBtn.onclick = saveVoucher;
        editingVoucherId = null;
      } else if (mode === 'edit') {
        title.innerHTML = '<i class="fas fa-edit"></i> Sửa Voucher';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Cập nhật';
        saveBtn.onclick = updateVoucher;
        editingVoucherId = voucherId;
      }
      
      modal.style.display = 'flex';
      voucherForm.reset();
      document.getElementById('statusActive').checked = true;
      
      // Tải sản phẩm
      loadProducts();
      
      // Nếu là chế độ sửa, tải dữ liệu voucher
      if (mode === 'edit') {
        loadVoucherForEdit(voucherId);
      }
    }
    
    // Đóng modal
    function closeVoucherModal() {
      voucherModal.style.display = 'none';
    }
    
    // Tải dữ liệu voucher để chỉnh sửa
    function loadVoucherForEdit(voucherId) {
      if (!currentUser) return;
      
      database.ref(`users/${currentUser.uid}/vouchers/${voucherId}`).once('value')
        .then(snapshot => {
          const voucher = snapshot.val();
          if (!voucher) return;
          
          // Điền dữ liệu vào form
          document.getElementById('voucherCode').value = voucher.code;
          document.getElementById('voucherName').value = voucher.name;
          
          if (voucher.discountType === 'percent') {
            document.getElementById('discountPercent').checked = true;
          } else {
            document.getElementById('discountAmount').checked = true;
          }
          
          document.getElementById('discountValue').value = voucher.discountValue;
          document.getElementById('minOrder').value = voucher.minOrder || '';
          document.getElementById('maxDiscount').value = voucher.maxDiscount || '';
          document.getElementById('startDate').value = voucher.startDate;
          document.getElementById('endDate').value = voucher.endDate;
          document.getElementById('totalQuantity').value = voucher.total;
          document.getElementById('perUserLimit').value = voucher.perUserLimit;
          
          if (voucher.status === 'active') {
            document.getElementById('statusActive').checked = true;
          } else {
            document.getElementById('statusInactive').checked = true;
          }
          
          // Chọn các sản phẩm áp dụng
          if (voucher.products && Array.isArray(voucher.products)) {
            voucher.products.forEach(productId => {
              const checkbox = document.getElementById(productId);
              if (checkbox) {
                checkbox.checked = true;
              }
            });
          }
        })
        .catch(error => {
          console.error('Error loading voucher:', error);
          showToast('Lỗi khi tải dữ liệu voucher', 'error');
        });
    }
    
    // Lưu voucher
    function saveVoucher() {
      if (!validateForm()) return;
      
      const voucherCode = document.getElementById('voucherCode').value.trim();
      const voucherName = document.getElementById('voucherName').value.trim();
      const discountType = document.querySelector('input[name="discountType"]:checked').value;
      const discountValue = parseFloat(document.getElementById('discountValue').value);
      const minOrder = document.getElementById('minOrder').value ? parseFloat(document.getElementById('minOrder').value) : 0;
      const maxDiscount = document.getElementById('maxDiscount').value ? parseFloat(document.getElementById('maxDiscount').value) : 0;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const totalQuantity = parseInt(document.getElementById('totalQuantity').value);
      const perUserLimit = parseInt(document.getElementById('perUserLimit').value);
      const status = document.querySelector('input[name="status"]:checked').value;
      
      // Lấy danh sách sản phẩm được chọn
      const selectedProducts = [];
      const productCheckboxes = productList.querySelectorAll('input[type="checkbox"]:checked');
      productCheckboxes.forEach(checkbox => {
        selectedProducts.push(checkbox.value);
      });
      
      // Tạo dữ liệu voucher
      const voucherData = {
        code: voucherCode,
        name: voucherName,
        discountType: discountType,
        discountValue: discountValue,
        minOrder: minOrder,
        maxDiscount: maxDiscount,
        startDate: startDate,
        endDate: endDate,
        total: totalQuantity,
        used: 0,
        perUserLimit: perUserLimit,
        products: selectedProducts,
        status: status,
        createdAt: new Date().toISOString()
      };
      
      // Lưu voucher vào Firebase
      const userVouchersRef = database.ref(`users/${currentUser.uid}/vouchers`);
      
      if (editingVoucherId) {
        // Cập nhật voucher hiện có
        userVouchersRef.child(editingVoucherId).update(voucherData)
          .then(() => {
            showToast('Cập nhật voucher thành công!', 'success');
            closeVoucherModal();
          })
          .catch(error => {
            console.error('Error updating voucher:', error);
            showToast('Có lỗi xảy ra: ' + error.message, 'error');
          });
      } else {
        // Tạo voucher mới
        userVouchersRef.push(voucherData)
          .then(() => {
            showToast('Thêm voucher thành công!', 'success');
            closeVoucherModal();
          })
          .catch(error => {
            console.error('Error saving voucher:', error);
            showToast('Có lỗi xảy ra: ' + error.message, 'error');
          });
      }
    }
    
    // Cập nhật voucher
    function updateVoucher() {
      saveVoucher(); // Sử dụng cùng hàm với thêm mới
    }
    
    // Validate form
    function validateForm() {
      let isValid = true;
      
      // Reset errors
      document.querySelectorAll('.error-message').forEach(el => {
        el.style.display = 'none';
      });
      
      // Validate voucher code
      const voucherCode = document.getElementById('voucherCode').value.trim();
      const codeRegex = /^[a-zA-Z0-9_-]+$/;
      if (!voucherCode || !codeRegex.test(voucherCode)) {
        document.getElementById('codeError').style.display = 'block';
        isValid = false;
      }
      
      // Validate voucher name
      const voucherName = document.getElementById('voucherName').value.trim();
      if (!voucherName) {
        document.getElementById('nameError').style.display = 'block';
        isValid = false;
      }
      
      // Validate discount value
      const discountValue = document.getElementById('discountValue').value;
      if (!discountValue || discountValue <= 0) {
        document.getElementById('valueError').style.display = 'block';
        isValid = false;
      }
      
      // Validate start date
      const startDate = document.getElementById('startDate').value;
      if (!startDate) {
        document.getElementById('startDateError').style.display = 'block';
        isValid = false;
      }
      
      // Validate end date
      const endDate = document.getElementById('endDate').value;
      if (!endDate) {
        document.getElementById('endDateError').style.display = 'block';
        isValid = false;
      }
      
      // Validate total quantity
      const totalQuantity = document.getElementById('totalQuantity').value;
      if (!totalQuantity || totalQuantity <= 0) {
        document.getElementById('quantityError').style.display = 'block';
        isValid = false;
      }
      
      // Validate per user limit
      const perUserLimit = document.getElementById('perUserLimit').value;
      if (!perUserLimit || perUserLimit <= 0) {
        document.getElementById('limitError').style.display = 'block';
        isValid = false;
      }
      
      return isValid;
    }
    
    // Toggle trạng thái voucher
    function toggleVoucherStatus(id, currentStatus) {
      if (!currentUser) return;
      
      const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
      const statusText = newStatus === 'active' ? 'kích hoạt' : 'vô hiệu hóa';
      
      database.ref(`users/${currentUser.uid}/vouchers/${id}/status`).set(newStatus)
        .then(() => {
          loadVouchers();
          showToast(`Đã ${statusText} voucher thành công!`, 'success');
        })
        .catch(error => {
          console.error('Error updating status:', error);
          showToast('Có lỗi xảy ra khi thay đổi trạng thái', 'error');
        });
    }
    
    // Mở xác nhận xóa voucher
    function openConfirmDeleteModal(id) {
      const modal = document.getElementById('confirm-delete-modal');
      const confirmBtn = document.getElementById('confirm-delete-btn');
      
      confirmBtn.onclick = function() {
        deleteVoucher(id);
      };
      
      modal.style.display = 'flex';
    }
    
    // Đóng xác nhận xóa
    function closeConfirmDeleteModal() {
      document.getElementById('confirm-delete-modal').style.display = 'none';
    }
    
    // Xóa voucher
    function deleteVoucher(id) {
      if (!currentUser) return;
      
      database.ref(`users/${currentUser.uid}/vouchers/${id}`).remove()
        .then(() => {
          closeConfirmDeleteModal();
          loadVouchers();
          showToast('Đã xóa voucher thành công!', 'success');
        })
        .catch(error => {
          console.error('Error deleting voucher:', error);
          showToast('Có lỗi xảy ra khi xóa voucher', 'error');
        });
    }
    
    // Tải danh sách voucher
    function loadVouchers() {
      if (!currentUser) return;
      
      const userVouchersRef = database.ref(`users/${currentUser.uid}/vouchers`);
      
      userVouchersRef.once('value')
        .then(snapshot => {
          const vouchers = snapshot.val();
          renderVoucherList(vouchers);
          
          // Hiển thị trạng thái trống nếu không có voucher
          if (!vouchers || Object.keys(vouchers).length === 0) {
            emptyVoucherState.style.display = 'block';
            voucherList.innerHTML = '';
          } else {
            emptyVoucherState.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error loading vouchers:', error);
          showToast('Lỗi khi tải danh sách voucher', 'error');
        });
    }
    
    // Hiển thị danh sách voucher
    function renderVoucherList(vouchers) {
      voucherList.innerHTML = '';
      
      if (!vouchers) {
        voucherList.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 30px;">Không có voucher nào</td></tr>';
        return;
      }
      
      Object.keys(vouchers).forEach(key => {
        const voucher = vouchers[key];
        
        // Định dạng giá trị giảm
        let discountValue = '';
        if (voucher.discountType === 'percent') {
          discountValue = `${voucher.discountValue}%`;
        } else {
          discountValue = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND'
          }).format(voucher.discountValue);
        }
        
        // Định dạng ngày hết hạn
        const endDate = new Date(voucher.endDate);
        const formattedEndDate = endDate.toLocaleDateString('vi-VN');
        
        // Xác định trạng thái
        let statusClass = 'status-inactive';
        let statusText = 'Ngừng hoạt động';
        
        if (voucher.status === 'active') {
          const today = new Date();
          if (endDate < today) {
            statusClass = 'status-expired';
            statusText = 'Đã hết hạn';
          } else {
            statusClass = 'status-active';
            statusText = 'Hoạt động';
          }
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${voucher.code}</td>
          <td>${voucher.name}</td>
          <td>${voucher.used || 0}/${voucher.total}</td>
          <td>${voucher.discountType === 'percent' ? 'Phần trăm' : 'Tiền mặt'}</td>
          <td>${discountValue}</td>
          <td>${formattedEndDate}</td>
          <td>
            <span class="status-badge ${statusClass}">
              ${statusText}
            </span>
          </td>
          <td class="action-buttons">
            <button class="action-btn edit" title="Chỉnh sửa" onclick="openVoucherModal('edit', '${key}')">
              <i class="fas fa-edit"></i>
            </button>
            ${voucher.status === 'active' ? 
              `<button class="action-btn disable" title="Vô hiệu hóa" onclick="toggleVoucherStatus('${key}', '${voucher.status}')">
                <i class="fas fa-ban"></i>
              </button>` : 
              `<button class="action-btn enable" title="Kích hoạt" onclick="toggleVoucherStatus('${key}', '${voucher.status}')">
                <i class="fas fa-check"></i>
              </button>`}
            <button class="action-btn delete" title="Xóa" onclick="openConfirmDeleteModal('${key}')">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;
        
        voucherList.appendChild(row);
      });
    }
    
    // Lọc voucher
    function filterVouchers() {
      const searchTerm = document.getElementById('voucher-search').value.toLowerCase();
      const rows = voucherList.getElementsByTagName('tr');
      
      for (let i = 0; i < rows.length; i++) {
        const code = rows[i].cells[0].textContent.toLowerCase();
        const name = rows[i].cells[1].textContent.toLowerCase();
        
        if (code.includes(searchTerm) || name.includes(searchTerm)) {
          rows[i].style.display = '';
        } else {
          rows[i].style.display = 'none';
        }
      }
    }
    
    // Hiển thị thông báo
    function showToast(message, type) {
      // Remove existing toasts
      const existingToasts = document.querySelectorAll('.toast');
      existingToasts.forEach(toast => toast.remove());
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(toast);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Toggle sidebar
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('closed');
      
      // Lưu trạng thái sidebar vào localStorage
      const isClosed = sidebar.classList.contains('closed');
      localStorage.setItem('sidebarClosed', isClosed);
      
      // Đóng tất cả submenu khi đóng sidebar
      if (isClosed) {
        document.querySelectorAll('.submenu').forEach(submenu => {
          submenu.classList.remove('show');
          const arrow = submenu.previousElementSibling.querySelector('.fa-chevron-down, .fa-chevron-up');
          if (arrow) {
            arrow.classList.remove('fa-chevron-up');
            arrow.classList.add('fa-chevron-down');
          }
        });
      }
    }

    // Toggle submenu
    function toggleBranchSubmenu() {
      toggleSubMenu('branch-submenu');
    }
    
    function toggleSubMenu(id) {
      const submenu = document.getElementById(id);
      const isOpen = submenu.classList.contains('show');
      
      // Đóng tất cả submenu khác trước khi mở submenu hiện tại
      document.querySelectorAll('.submenu').forEach(item => {
        if (item.id !== id) {
          item.classList.remove('show');
          const arrow = item.previousElementSibling.querySelector('.fa-chevron-up');
          if (arrow) {
            arrow.classList.remove('fa-chevron-up');
            arrow.classList.add('fa-chevron-down');
          }
        }
      });
      
      // Mở/đóng submenu hiện tại
      submenu.classList.toggle('show');
      
      // Đổi icon mũi tên
      const arrow = document.getElementById('branch-arrow');
      if (arrow) {
        arrow.classList.toggle('fa-chevron-down');
        arrow.classList.toggle('fa-chevron-up');
      }
    }

    // Khởi tạo trạng thái sidebar từ localStorage
    document.addEventListener('DOMContentLoaded', function() {
      const isClosed = localStorage.getItem('sidebarClosed') === 'true';
      if (isClosed) {
        document.getElementById('sidebar').classList.add('closed');
      }
      
      // Đóng tất cả submenu khi trang được tải
      document.querySelectorAll('.submenu').forEach(submenu => {
        submenu.classList.remove('show');
      });
      
      // Thêm sự kiện cho nút đóng modal
      closeModalBtn.addEventListener('click', closeVoucherModal);
      cancelBtn.addEventListener('click', closeVoucherModal);
      
      // Thêm sự kiện cho nút thêm voucher
      addVoucherBtn.addEventListener('click', () => {
        openVoucherModal('add');
      });
    });
  </script>
</body>
</html>