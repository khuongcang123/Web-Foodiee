<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Trang chủ - Foodiee Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #2c3e50;
      --secondary: #3498db;
      --accent: #e74c3c;
      --light: #ecf0f1;
      --dark: #2c3e50;
      --success: #2ecc71;
      --warning: #f39c12;
      --gray: #95a5a6;
      --sidebar-width: 250px;
      --sidebar-collapsed: 70px;
      --transition-speed: 0.3s;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      overflow-x: hidden;
      display: flex;
      min-height: 100vh;
    }

    /* Header */
    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 2px solid var(--secondary);
      margin-bottom: 30px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .notification-icon {
      position: relative;
      cursor: pointer;
      font-size: 1.3rem;
      color: var(--primary);
      transition: transform 0.3s;
    }

    .notification-icon:hover {
      transform: scale(1.1);
      color: var(--accent);
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: var(--accent);
      color: white;
      font-size: 0.7rem;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
    }

    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary), var(--primary));
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-weight: bold;
      font-size: 1.2rem;
      background-size: cover;
      background-position: center;
    }

    .user-name {
      font-weight: 500;
      color: var(--primary);
    }

    /* Sidebar */
    .sidebar {
      background: linear-gradient(135deg, var(--primary), #1a2530);
      color: white;
      width: var(--sidebar-width);
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1000;
      overflow-y: auto;
      transition: all var(--transition-speed) ease;
      box-shadow: 3px 0 15px rgba(0, 0, 0, 0.1);
    }

    .sidebar.closed {
      width: var(--sidebar-collapsed);
    }

    .toggle-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: white;
      width: 100%;
      padding: 15px;
      cursor: pointer;
      text-align: left;
      display: flex;
      align-items: center;
      transition: background 0.3s;
    }

    .toggle-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .toggle-btn i {
      font-size: 1.5rem;
      margin-right: 15px;
    }

    .sidebar.closed .toggle-btn i {
      margin-right: 0;
    }

    .nav-menu {
      padding: 15px 0;
    }

    .nav-menu ul {
      list-style: none;
    }

    .nav-menu ul li {
      position: relative;
    }

    .nav-menu ul li a {
      color: rgba(255, 255, 255, 0.8);
      text-decoration: none;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .nav-menu ul li a:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .nav-menu ul li a.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-left: 4px solid var(--accent);
    }

    .nav-menu ul li a i {
      font-size: 1.2rem;
      min-width: 30px;
      text-align: center;
      transition: transform 0.3s;
    }

    .link-text {
      margin-left: 15px;
      transition: opacity var(--transition-speed), margin var(--transition-speed);
      white-space: nowrap;
    }

    .sidebar.closed .link-text {
      opacity: 0;
      margin-left: -10px;
      pointer-events: none;
    }

    /* Submenu */
    .submenu {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.4s ease-out;
      background: rgba(0, 0, 0, 0.15);
      padding-left: 0;
    }

    .submenu.show {
      max-height: 500px;
    }

    .submenu li a {
      padding: 12px 20px 12px 60px !important;
      font-size: 0.9rem;
    }

    .submenu li a i {
      font-size: 0.9rem;
    }

    /* Fix submenu khi sidebar đóng */
    .sidebar.closed .submenu {
      position: absolute;
      left: 100%;
      top: 0;
      min-width: 200px;
      background: #2c3e50;
      border-radius: 0 8px 8px 0;
      box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
      z-index: 1001;
    }

    .sidebar.closed .submenu.show {
      max-height: none;
      display: block;
    }

    .sidebar.closed .submenu li a {
      padding: 12px 15px !important;
    }

    .sidebar.closed .submenu .link-text {
      opacity: 1;
      margin-left: 10px;
      pointer-events: auto;
    }

    /* Main content */
    main {
      flex: 1;
      padding: 30px;
      margin-left: var(--sidebar-width);
      transition: all var(--transition-speed);
    }

    .sidebar.closed + main {
      margin-left: var(--sidebar-collapsed);
      padding: 30px 20px;
    }

    h1 {
      color: var(--primary);
      font-weight: 600;
    }
    
    .welcome-section {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      position: relative;
      overflow: hidden;
    }
    
    .welcome-section::before {
      content: "";
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      transform: rotate(30deg);
      z-index: 0;
    }
    
    .welcome-section h2 {
      font-size: 2rem;
      margin-bottom: 10px;
      font-weight: 600;
      position: relative;
      z-index: 1;
    }
    
    .welcome-section p {
      font-size: 1.1rem;
      max-width: 700px;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    /* Dashboard Cards */
    .dashboard-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 25px;
      margin-top: 20px;
    }

    .card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s, box-shadow 0.3s;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    .card-header {
      background: var(--secondary);
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
    }

    .card-header i {
      font-size: 2rem;
      margin-right: 15px;
    }

    .card-header h2 {
      font-size: 1.3rem;
      font-weight: 500;
    }

    .card-body {
      padding: 20px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary);
      margin: 10px 0;
    }

    .stat-desc {
      color: var(--gray);
      font-size: 0.95rem;
      margin-bottom: 10px;
    }

    .progress-container {
      margin-top: 15px;
    }

    .progress-bar {
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--success);
      border-radius: 4px;
    }
    
    .detail-button {
      margin-top: auto;
      padding-top: 15px;
      display: flex;
      justify-content: flex-end;
    }
    
    .btn-detail {
      background: var(--secondary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.95rem;
    }
    
    .btn-detail:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }
    
    .btn-detail i {
      font-size: 0.9rem;
    }
    
    /* Revenue Section Styles */
    .revenue-section {
      margin-top: 40px;
    }
    
    .section-title {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--light);
    }
    
    .time-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .time-button {
      padding: 8px 16px;
      border: none;
      border-radius: 20px;
      background: #f1f5f9;
      color: #64748b;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 500;
    }
    
    .time-button.active {
      background: var(--secondary);
      color: white;
    }
    
    .main-revenue-card {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      color: white;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .main-revenue-label {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
      opacity: 0.9;
    }
    
    .main-revenue-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 16px;
    }
    
    .revenue-comparison {
      display: inline-flex;
      align-items: center;
      background: rgba(255, 255, 255, 0.15);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
    }
    
    .revenue-comparison i {
      margin-right: 8px;
    }
    
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }
    
    .chart-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      padding: 15px;
      height: 250px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .chart-card h3 {
      margin-top: 0;
      color: var(--primary);
      text-align: center;
      margin-bottom: 15px;
      font-size: 16px;
    }
    
    .chart-container {
      flex: 1;
      position: relative;
      height: 200px;
      overflow: hidden;
    }
    
    .chart-container canvas {
      max-width: 100%;
      max-height: 100%;
    }
    
    .top-branches-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.05);
      padding: 20px;
      margin-top: 30px;
    }
    
    .top-branch-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid #eee;
    }
    
    .top-branch-item:last-child {
      border-bottom: none;
    }
    
    .branch-rank {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: var(--secondary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
    }
    
    .branch-rank-1 {
      background: gold;
    }
    
    .branch-rank-2 {
      background: silver;
    }
    
    .branch-rank-3 {
      background: #cd7f32; /* bronze */
    }
    
    .branch-info {
      flex: 1;
    }
    
    .branch-name {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .branch-revenue {
      color: var(--success);
      font-weight: 500;
    }
    
    /* Payment method badges */
    .payment-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .payment-cash {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }
    
    .payment-bank {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }
    
    .payment-other {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
    }
    
    /* Loading animation */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .charts-container {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    @media (max-width: 992px) {
      .sidebar {
        width: var(--sidebar-collapsed);
      }
      
      .sidebar:not(.closed) {
        width: var(--sidebar-width);
      }
      
      main {
        margin-left: var(--sidebar-collapsed);
        padding: 30px 20px;
      }
      
      .sidebar:not(.closed) + main {
        margin-left: var(--sidebar-width);
        padding: 30px;
      }
      
      .charts-container {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .dashboard-container {
        grid-template-columns: 1fr;
      }
      
      .header-right {
        gap: 15px;
      }
      
      .user-name {
        display: none;
      }
      
      .time-filter {
        flex-wrap: wrap;
      }
      
      .time-button {
        flex: 1;
        min-width: 80px;
        text-align: center;
      }
      
      .chart-card {
        height: 250px;
      }
    }

    @media (max-width: 480px) {
      .main-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .header-right {
        align-self: flex-end;
      }
      
      .welcome-section {
        padding: 20px;
      }
      
      .welcome-section h2 {
        font-size: 1.6rem;
      }
      
      .card-body {
        padding: 15px;
      }
      
      .main-revenue-card {
        padding: 20px;
      }
      
      .main-revenue-value {
        font-size: 28px;
      }
      
      .chart-card {
        padding: 15px;
        height: 220px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>
    <nav class="nav-menu">
      <ul>
        <li><a href="tongquan.html" class="active"><i class="fas fa-chart-line"></i><span class="link-text">Tổng quan</span></a></li>
        <li><a href="quanlychinhanh.html"><i class="fas fa-building"></i><span class="link-text">Quản lý chi nhánh</span></a></li>
        <li>
          <a href="#" onclick="toggleBranchSubmenu()">
            <i class="fas fa-store-alt"></i>
            <span class="link-text">Quản lý nhà hàng</span>
            <i id="branch-arrow" class="fas fa-chevron-down" style="float: right;"></i>
          </a>
          <ul class="submenu" id="branch-submenu" style="display: none; padding-left: 20px;"></ul>
        </li>
        <li><a href="quanlynhanvien.html"><i class="fas fa-user-friends"></i><span class="link-text">Quản lý nhân viên</span></a></li>
        <li><a href="quanlydanhmuc.html"><i class="fas fa-list-alt"></i><span class="link-text">Quản lý danh mục</span></a></li>
        <li><a href="quanlymenu.html"><i class="fas fa-utensils"></i><span class="link-text">Quản lý menu</span></a></li>
        <li><a href="quanlykhachhang.html"><i class="fas fa-user"></i><span class="link-text">Quản lý khách hàng</span></a></li>
        <li><a href="quanlyvoucher.html"><i class="fas fa-ticket-alt"></i><span class="link-text">Quản lý voucher</span></a></li>
        <li><a href="setting.html"><i class="fas fa-cogs"></i><span class="link-text">Cài đặt</span></a></li>
      </ul>
    </nav>
  </div>
  
  <main>
    <div class="main-header">
      <h1>Trang chủ</h1>
      <div class="header-right">
        <div class="notification-icon" id="notification-icon">
          <i class="fas fa-bell"></i>
          <span class="notification-badge" id="notification-badge">0</span>
        </div>
        <div class="user-profile">
          <div class="avatar" id="header-avatar">A</div>
          <span class="user-name" id="header-username">Admin</span>
        </div>
      </div>
    </div>
    
    <div class="dashboard-container">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-users"></i>
          <h2>Nhân viên</h2>
        </div>
        <div class="card-body">
          <div class="stat-number" id="employee-count">0</div>
          <div class="stat-desc">Nhân viên đang hoạt động</div>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 0%" id="employee-progress"></div>
            </div>
          </div>
          <div class="detail-button">
            <button class="btn-detail" id="employee-detail-btn">
              <i class="fas fa-external-link-alt"></i> Xem chi tiết
            </button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <i class="fas fa-store"></i>
          <h2>Nhà hàng</h2>
        </div>
        <div class="card-body">
          <div class="stat-number" id="branch-count">0</div>
          <div class="stat-desc">Chi nhánh đang hoạt động</div>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 0%" id="branch-progress"></div>
            </div>
          </div>
          <div class="detail-button">
            <button class="btn-detail" id="branch-detail-btn">
              <i class="fas fa-external-link-alt"></i> Xem chi tiết
            </button>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header">
          <i class="fas fa-utensils"></i>
          <h2>Thực đơn</h2>
        </div>
        <div class="card-body">
          <div class="stat-number" id="menu-count">0</div>
          <div class="stat-desc">Món ăn đang phục vụ</div>
          <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-fill" style="width: 0%" id="menu-progress"></div>
            </div>
          </div>
          <div class="detail-button">
            <button class="btn-detail" id="menu-detail-btn">
              <i class="fas fa-external-link-alt"></i> Xem chi tiết
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Revenue Section -->
    <div class="revenue-section">
      <h2 class="section-title">Tổng quan Doanh thu</h2>
      
      <div class="time-filter">
        <button class="time-button active" data-period="today">Hôm nay</button>
        <button class="time-button" data-period="week">Tuần</button>
        <button class="time-button" data-period="month">Tháng</button>
        <button class="time-button" data-period="all">Tất cả</button>
      </div>
      
      <!-- Main Revenue Card -->
      <div class="main-revenue-card">
        <div class="main-revenue-label" id="revenue-period-label">DOANH THU HÔM NAY</div>
        <div class="main-revenue-value" id="main-revenue-value">0 đ</div>
        <div class="revenue-comparison">
          <i class="fas fa-chart-line"></i>
          <span id="revenue-comparison-text">Không có dữ liệu so sánh</span>
        </div>
      </div>
      
      <!-- Stats Cards -->
      <div class="dashboard-container">
        <div class="card">
          <div class="card-header">
            <i class="fas fa-shopping-bag"></i>
            <h2>Tổng đơn hàng</h2>
          </div>
          <div class="card-body">
            <div class="stat-number" id="total-orders">0</div>
            <div class="stat-desc">Số lượng đơn hàng</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <i class="fas fa-takeaway-box"></i>
            <h2>Mang về</h2>
          </div>
          <div class="card-body">
            <div class="stat-number" id="takeaway-orders">0</div>
            <div class="stat-desc">Đơn hàng mang về</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <i class="fas fa-utensils"></i>
            <h2>Tại chỗ</h2>
          </div>
          <div class="card-body">
            <div class="stat-number" id="dinein-orders">0</div>
            <div class="stat-desc">Đơn hàng tại chỗ</div>
          </div>
        </div>
        
        <div class="card">
          <div class="card-header">
            <i class="fas fa-money-bill-wave"></i>
            <h2>Trung bình/đơn</h2>
          </div>
          <div class="card-body">
            <div class="stat-number" id="avg-order-value">0 đ</div>
            <div class="stat-desc">Giá trị trung bình</div>
          </div>
        </div>
      </div>
      
      <!-- Charts Container -->
      <div class="charts-container">
        <div class="chart-card">
          <h3>Doanh thu theo ngày</h3>
          <div class="chart-container">
            <canvas id="daily-revenue-chart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Phân loại đơn hàng</h3>
          <div class="chart-container">
            <canvas id="order-type-chart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Phương thức thanh toán</h3>
          <div class="chart-container">
            <canvas id="payment-method-chart"></canvas>
          </div>
        </div>
      </div>
      
      <!-- Top 3 Chi nhánh bán chạy nhất -->
      <div class="top-branches-container">
        <h3>Top 3 Chi nhánh bán chạy nhất</h3>
        <div id="top-branches-list">
          <div class="empty-state" style="padding: 20px; text-align: center;">
            <i class="fas fa-store-slash" style="font-size: 48px; color: #e0e0e0; margin-bottom: 15px;"></i>
            <p>Đang tải dữ liệu chi nhánh...</p>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBzAdWAVjD_NQP3uglLYOOFWUmDGsylsg0",
      authDomain: "foodiee-fcdc1.firebaseapp.com",
      databaseURL: "https://foodiee-fcdc1-default-rtdb.firebaseio.com",
      projectId: "foodiee-fcdc1",
      storageBucket: "foodiee-fcdc1.firebasestorage.app",
      messagingSenderId: "993331259398",
      appId: "1:993331259398:web:2b922ef5e0519d5e237b87",
      measurementId: "G-PDT1VE8JL5"
    };

    // Khởi tạo Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();
    
    // Biến toàn cục
    let currentUser = null;
    let allOrders = {};
    let allBranches = {};
    let currentRevenuePeriod = 'today';
    let dailyRevenueChart, orderTypeChart, paymentMethodChart;
    
    // Sidebar toggle
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('closed');
      
      // Lưu trạng thái sidebar vào localStorage
      const isClosed = sidebar.classList.contains('closed');
      localStorage.setItem('sidebarClosed', isClosed);
      
      // Đóng tất cả submenu khi đóng sidebar
      if (isClosed) { 
        document.querySelectorAll('.submenu').forEach(submenu => {
          submenu.classList.remove('show');
          const arrow = submenu.previousElementSibling.querySelector('.fa-chevron-down, .fa-chevron-up');
          if (arrow) {
            arrow.classList.remove('fa-chevron-up');
            arrow.classList.add('fa-chevron-down');
          }
        });
      }
      
      // Cập nhật lại biểu đồ để điều chỉnh kích thước
      setTimeout(() => {
        if (dailyRevenueChart) dailyRevenueChart.resize();
        if (orderTypeChart) orderTypeChart.resize();
        if (paymentMethodChart) paymentMethodChart.resize();
      }, 300);
    }

    // Toggle submenu
    function toggleBranchSubmenu() {
      const submenu = document.getElementById('branch-submenu');
      const isOpen = submenu.classList.contains('show');
      
      // Đóng tất cả submenu khác trước khi mở submenu hiện tại
      document.querySelectorAll('.submenu').forEach(item => {
        if (item.id !== 'branch-submenu') {
          item.classList.remove('show');
          const arrow = item.previousElementSibling.querySelector('.fa-chevron-up');
          if (arrow) {
            arrow.classList.remove('fa-chevron-up');
            arrow.classList.add('fa-chevron-down');
          }
        }
      });
      
      // Mở/đóng submenu hiện tại
      submenu.classList.toggle('show');
      
      // Đổi icon mũi tên
      const arrow = document.getElementById('branch-arrow');
      if (arrow) {
        arrow.classList.toggle('fa-chevron-down');
        arrow.classList.toggle('fa-chevron-up');
      }
    }

    // Khởi tạo trạng thái sidebar từ localStorage
    document.addEventListener('DOMContentLoaded', function() {
      const isClosed = localStorage.getItem('sidebarClosed') === 'true';
      if (isClosed) {
        document.getElementById('sidebar').classList.add('closed');
      }
      
      // Đóng tất cả submenu khi trang được tải
      document.querySelectorAll('.submenu').forEach(submenu => {
        submenu.classList.remove('show');
      });
      
      // Thêm sự kiện cho nút xem chi tiết
      document.getElementById('employee-detail-btn').addEventListener('click', () => {
        window.location.href = 'quanlynhanvien.html';
      });
      
      document.getElementById('branch-detail-btn').addEventListener('click', () => {
        window.location.href = 'quanlychinhanh.html';
      });
      
      document.getElementById('menu-detail-btn').addEventListener('click', () => {
        window.location.href = 'quanlymenu.html';
      });
      
      // Thiết lập sự kiện cho các nút lọc thời gian
      document.querySelectorAll('.time-button').forEach(button => {
        button.addEventListener('click', function() {
          document.querySelectorAll('.time-button').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          currentRevenuePeriod = this.dataset.period;
          updateRevenueStats();
          renderRevenueCharts();
        });
      });
    });
    
    // Hàm đếm nhân viên đang hoạt động
    function loadActiveEmployees(userId) {
      const employeeRef = database.ref(`users/${userId}/employees`);
      return employeeRef.once('value').then(snapshot => {
        let count = 0;
        if (snapshot.exists()) {
          snapshot.forEach(childSnapshot => {
            const employee = childSnapshot.val();
            if (employee.status === 'active') {
              count++;
            }
          });
        }
        return count;
      });
    }
    
    // Hàm đếm chi nhánh đang hoạt động
    function loadActiveBranches(userId) {
      const branchRef = database.ref(`users/${userId}/branches`);
      return branchRef.once('value').then(snapshot => {
        let count = 0;
        if (snapshot.exists()) {
          snapshot.forEach(childSnapshot => {
            const branch = childSnapshot.val();
            if (branch.status === 'active') {
              count++;
            }
          });
        }
        return count;
      });
    }
    
    // Hàm đếm món ăn đang phục vụ
    function loadActiveMenuItems(userId) {
      const menuRef = database.ref(`users/${userId}/menu`);
      return menuRef.once('value').then(snapshot => {
        let count = 0;
        if (snapshot.exists()) {
          snapshot.forEach(childSnapshot => {
            const menuItem = childSnapshot.val();
            if (menuItem.status === 'active') {
              count++;
            }
          });
        }
        return count;
      });
    }
    
    // Hàm lấy tất cả đơn hàng từ tất cả chi nhánh
    function loadAllOrders(userId) {
      return new Promise((resolve, reject) => {
        const ordersRef = database.ref(`users/${userId}/branches`);
        ordersRef.once('value').then(snapshot => {
          allOrders = {};
          allBranches = snapshot.val() || {};
          
          // Lấy tất cả đơn hàng từ tất cả chi nhánh
          const orderPromises = [];
          
          Object.keys(allBranches).forEach(branchCode => {
            const branchOrdersRef = database.ref(`users/${userId}/branches/${branchCode}/orders`);
            orderPromises.push(
              branchOrdersRef.once('value').then(branchSnapshot => {
                if (branchSnapshot.exists()) {
                  branchSnapshot.forEach(orderSnapshot => {
                    const order = orderSnapshot.val();
                    // Chỉ lấy các đơn đã thanh toán
                    if (order.status === 'đã thanh toán' || order.status === 'completed') {
                      allOrders[orderSnapshot.key] = {
                        id: orderSnapshot.key,
                        branchCode: branchCode,
                        branchName: allBranches[branchCode].name || branchCode,
                        ...order,
                        createdAt: order.createdAt || new Date().toISOString(),
                        paymentMethod: order.paymentMethod || 'unknown'
                      };
                    }
                  });
                }
              })
            );
          });
          
          Promise.all(orderPromises).then(() => {
            resolve(allOrders);
          }).catch(reject);
        }).catch(reject);
      });
    }
    
    // Cập nhật giao diện với dữ liệu thực
    function updateDashboard(userId) {
      // Hiển thị trạng thái loading
      document.getElementById('employee-count').innerHTML = '<span class="loading"></span>';
      document.getElementById('branch-count').innerHTML = '<span class="loading"></span>';
      document.getElementById('menu-count').innerHTML = '<span class="loading"></span>';
      
      // Tải dữ liệu song song
      Promise.all([
        loadActiveEmployees(userId),
        loadActiveBranches(userId),
        loadActiveMenuItems(userId),
        loadAllOrders(userId)
      ]).then(results => {
        const [employeeCount, branchCount, menuCount] = results;
        
        // Cập nhật UI
        document.getElementById('employee-count').textContent = employeeCount;
        document.getElementById('employee-progress').style.width = '100%';
        
        document.getElementById('branch-count').textContent = branchCount;
        document.getElementById('branch-progress').style.width = '100%';
        
        document.getElementById('menu-count').textContent = menuCount;
        document.getElementById('menu-progress').style.width = '100%';
        
        // Cập nhật thống kê doanh thu
        updateRevenueStats();
        renderRevenueCharts();
        renderTopBranches();
      }).catch(error => {
        console.error('Lỗi khi tải dữ liệu:', error);
        
        // Hiển thị giá trị mặc định nếu có lỗi
        document.getElementById('employee-count').textContent = '0';
        document.getElementById('branch-count').textContent = '0';
        document.getElementById('menu-count').textContent = '0';
      });
    }
    
    // Cập nhật thống kê doanh thu
    function updateRevenueStats() {
      const now = new Date();
      let filteredOrders = Object.values(allOrders);
      let periodLabel = 'TẤT CẢ DOANH THU';
      let comparisonText = 'Không có dữ liệu so sánh';

      // Lọc đơn hàng theo khoảng thời gian
      switch(currentRevenuePeriod) {
        case 'today':
          const today = now.toISOString().split('T')[0];
          filteredOrders = filteredOrders.filter(order => order.createdAt.includes(today));
          periodLabel = 'DOANH THU HÔM NAY';
          
          // Tính % thay đổi so với hôm qua
          const yesterday = new Date(now);
          yesterday.setDate(yesterday.getDate() - 1);
          const yesterdayStr = yesterday.toISOString().split('T')[0];
          const yesterdayOrders = Object.values(allOrders).filter(order => 
            order.createdAt.includes(yesterdayStr));
          
          const yesterdayRevenue = yesterdayOrders.reduce((sum, order) => sum + (order.total || 0), 0);
          const todayRevenue = filteredOrders.reduce((sum, order) => sum + (order.total || 0), 0);
          
          if (yesterdayRevenue > 0) {
            const changePercent = ((todayRevenue - yesterdayRevenue) / yesterdayRevenue * 100).toFixed(1);
            comparisonText = `So với hôm qua: ${changePercent}%`;
          }
          break;
          
        case 'week':
          const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
          filteredOrders = filteredOrders.filter(order => new Date(order.createdAt) >= weekStart);
          periodLabel = 'DOANH THU TUẦN NÀY';
          
          // Tính % thay đổi so với tuần trước
          const lastWeekStart = new Date(weekStart);
          lastWeekStart.setDate(lastWeekStart.getDate() - 7);
          const lastWeekEnd = new Date(weekStart);
          lastWeekEnd.setDate(lastWeekEnd.getDate() - 1);
          
          const lastWeekOrders = Object.values(allOrders).filter(order => {
            const orderDate = new Date(order.createdAt);
            return orderDate >= lastWeekStart && orderDate <= lastWeekEnd;
          });
          
          const lastWeekRevenue = lastWeekOrders.reduce((sum, order) => sum + (order.total || 0), 0);
          const thisWeekRevenue = filteredOrders.reduce((sum, order) => sum + (order.total || 0), 0);
          
          if (lastWeekRevenue > 0) {
            const changePercent = ((thisWeekRevenue - lastWeekRevenue) / lastWeekRevenue * 100).toFixed(1);
            comparisonText = `So với tuần trước: ${changePercent}%`;
          }
          break;
          
        case 'month':
          const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          filteredOrders = filteredOrders.filter(order => new Date(order.createdAt) >= monthStart);
          periodLabel = 'DOANH THU THÁNG NÀY';
          
          // Tính % thay đổi so với tháng trước
          const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
          const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);
          
          const lastMonthOrders = Object.values(allOrders).filter(order => {
            const orderDate = new Date(order.createdAt);
            return orderDate >= lastMonthStart && orderDate <= lastMonthEnd;
          });
          
          const lastMonthRevenue = lastMonthOrders.reduce((sum, order) => sum + (order.total || 0), 0);
          const thisMonthRevenue = filteredOrders.reduce((sum, order) => sum + (order.total || 0), 0);
          
          if (lastMonthRevenue > 0) {
            const changePercent = ((thisMonthRevenue - lastMonthRevenue) / lastMonthRevenue * 100).toFixed(1);
            comparisonText = `So với tháng trước: ${changePercent}%`;
          }
          break;
          
        case 'all':
          // Không lọc gì cả, lấy tất cả đơn hàng
          break;
      }

      // Tính toán thống kê
      const totalRevenue = filteredOrders.reduce((sum, order) => sum + (order.total || 0), 0);
      const totalOrders = filteredOrders.length;
      const takeawayOrders = filteredOrders.filter(order => order.type === 'takeaway').length;
      const dineinOrders = filteredOrders.filter(order => order.type === 'dine-in').length;
      const avgOrderValue = totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0;

      // Cập nhật UI
      document.getElementById('revenue-period-label').textContent = periodLabel;
      document.getElementById('main-revenue-value').textContent = totalRevenue.toLocaleString() + ' đ';
      document.getElementById('revenue-comparison-text').textContent = comparisonText;
      document.getElementById('total-orders').textContent = totalOrders;
      document.getElementById('takeaway-orders').textContent = takeawayOrders;
      document.getElementById('dinein-orders').textContent = dineinOrders;
      document.getElementById('avg-order-value').textContent = avgOrderValue.toLocaleString() + ' đ';
    }
    
    // Vẽ biểu đồ doanh thu
    function renderRevenueCharts() {
      const now = new Date();
      let filteredOrders = Object.values(allOrders);

      // Lọc đơn hàng theo khoảng thời gian
      switch(currentRevenuePeriod) {
        case 'today':
          const today = now.toISOString().split('T')[0];
          filteredOrders = filteredOrders.filter(order => order.createdAt.includes(today));
          break;
          
        case 'week':
          const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
          filteredOrders = filteredOrders.filter(order => new Date(order.createdAt) >= weekStart);
          break;
          
        case 'month':
          const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          filteredOrders = filteredOrders.filter(order => new Date(order.createdAt) >= monthStart);
          break;
          
        case 'all':
          // Không lọc gì cả
          break;
      }

      // Chuẩn bị dữ liệu cho các biểu đồ
      prepareDailyRevenueChart(filteredOrders);
      prepareOrderTypeChart(filteredOrders);
      preparePaymentMethodChart(filteredOrders);
    }
    
    // Chuẩn bị dữ liệu cho biểu đồ doanh thu theo ngày
    function prepareDailyRevenueChart(orders) {
      const dailyData = {};
      
      // Nhóm doanh thu theo ngày
      orders.forEach(order => {
        const date = new Date(order.createdAt).toLocaleDateString('vi-VN');
        if (!dailyData[date]) {
          dailyData[date] = 0;
        }
        dailyData[date] += order.total || 0;
      });
      
      // Chuyển đổi thành mảng để vẽ biểu đồ
      const labels = Object.keys(dailyData).sort((a, b) => new Date(a) - new Date(b));
      const data = labels.map(date => dailyData[date]);
      
      // Vẽ hoặc cập nhật biểu đồ
      const ctx = document.getElementById('daily-revenue-chart').getContext('2d');
      
      if (dailyRevenueChart) {
        dailyRevenueChart.data.labels = labels;
        dailyRevenueChart.data.datasets[0].data = data;
        dailyRevenueChart.update();
      } else {
        dailyRevenueChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{
              label: 'Doanh thu',
              data: data,
              backgroundColor: 'rgba(59, 130, 246, 0.5)',
              borderColor: 'rgba(59, 130, 246, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value.toLocaleString() + ' đ';
                  }
                }
              },
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45
                }
              }
            },
            plugins: {
              legend: {
                display: false
              }
            }
          }
        });
      }
    }
    
    // Chuẩn bị dữ liệu cho biểu đồ phân loại đơn hàng
    function prepareOrderTypeChart(orders) {
      const typeData = {
        takeaway: 0,
        dinein: 0
      };
      
      orders.forEach(order => {
        if (order.type === 'takeaway') {
          typeData.takeaway += order.total || 0;
        } else {
          typeData.dinein += order.total || 0;
        }
      });
      
      const ctx = document.getElementById('order-type-chart').getContext('2d');
      const data = [typeData.takeaway, typeData.dinein];
      
      if (orderTypeChart) {
        orderTypeChart.data.datasets[0].data = data;
        orderTypeChart.update();
      } else {
        orderTypeChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Mang về', 'Tại chỗ'],
            datasets: [{
              data: data,
              backgroundColor: [
                'rgba(16, 185, 129, 0.5)',
                'rgba(59, 130, 246, 0.5)'
              ],
              borderColor: [
                'rgba(16, 185, 129, 1)',
                'rgba(59, 130, 246, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  boxWidth: 12,
                  font: {
                    size: 11
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    return `${label}: ${value.toLocaleString()} đ (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }
    }
    
    // Chuẩn bị dữ liệu cho biểu đồ phương thức thanh toán
    function preparePaymentMethodChart(orders) {
      const paymentData = {
        cash: 0,
        bank: 0,
        other: 0
      };
      
      orders.forEach(order => {
        const method = order.paymentMethod || 'other';
        paymentData[method] += order.total || 0;
      });
      
      const ctx = document.getElementById('payment-method-chart').getContext('2d');
      const data = [paymentData.cash, paymentData.bank, paymentData.other];
      
      if (paymentMethodChart) {
        paymentMethodChart.data.datasets[0].data = data;
        paymentMethodChart.update();
      } else {
        paymentMethodChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Tiền mặt', 'Chuyển khoản', 'Khác'],
            datasets: [{
              data: data,
              backgroundColor: [
                'rgba(16, 185, 129, 0.5)',
                'rgba(59, 130, 246, 0.5)',
                'rgba(107, 114, 128, 0.5)'
              ],
              borderColor: [
                'rgba(16, 185, 129, 1)',
                'rgba(59, 130, 246, 1)',
                'rgba(107, 114, 128, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  boxWidth: 12,
                  font: {
                    size: 11
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.raw || 0;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = Math.round((value / total) * 100);
                    return `${label}: ${value.toLocaleString()} đ (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }
    }
    
    // Hiển thị top 3 chi nhánh bán chạy nhất
    function renderTopBranches() {
      const branchRevenue = {};
      
      // Tính tổng doanh thu cho từng chi nhánh
      Object.values(allOrders).forEach(order => {
        if (!branchRevenue[order.branchCode]) {
          branchRevenue[order.branchCode] = {
            name: order.branchName,
            revenue: 0
          };
        }
        branchRevenue[order.branchCode].revenue += order.total || 0;
      });
      
      // Chuyển đổi thành mảng và sắp xếp theo doanh thu giảm dần
      const topBranches = Object.entries(branchRevenue)
        .map(([code, data]) => ({ code, ...data }))
        .sort((a, b) => b.revenue - a.revenue)
        .slice(0, 3); // Lấy top 3
      
      const topBranchesList = document.getElementById('top-branches-list');
      
      if (topBranches.length === 0) {
        topBranchesList.innerHTML = `
          <div class="empty-state" style="padding: 20px; text-align: center;">
            <i class="fas fa-store-slash" style="font-size: 48px; color: #e0e0e0; margin-bottom: 15px;"></i>
            <p>Chưa có dữ liệu doanh thu từ chi nhánh</p>
          </div>
        `;
        return;
      }
      
      topBranchesList.innerHTML = '';
      
      topBranches.forEach((branch, index) => {
        const rankClass = `branch-rank branch-rank-${index + 1}`;
        const branchElement = document.createElement('div');
        branchElement.className = 'top-branch-item';
        branchElement.innerHTML = `
          <div style="display: flex; align-items: center;">
            <div class="${rankClass}">${index + 1}</div>
            <div class="branch-info">
              <div class="branch-name">${branch.name}</div>
              <div class="branch-revenue">${branch.revenue.toLocaleString()} đ</div>
            </div>
          </div>
        `;
        topBranchesList.appendChild(branchElement);
      });
    }
    
    // Authentication state change
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        const uid = user.uid;
        const userRef = firebase.database().ref('users/' + uid);
        userRef.once('value').then((snapshot) => {
          const data = snapshot.val();
          if (!data) return;

          const avatarUrl = data.info_user?.avatarUrl || '';
          const displayName = data.info_user?.displayName || user.displayName || user.email.split('@')[0];

          // Gán tên
          const nameEl = document.getElementById('header-username');
          if (nameEl) nameEl.textContent = displayName;

          // Gán avatar
          const avatarEl = document.getElementById('header-avatar');
          if (avatarEl) {
            if (avatarUrl) {
              avatarEl.style.backgroundImage = `url(${avatarUrl})`;
              avatarEl.style.backgroundSize = 'cover';
              avatarEl.style.backgroundPosition = 'center';
              avatarEl.textContent = '';
            } else {
              avatarEl.style.backgroundImage = '';
              avatarEl.textContent = displayName.charAt(0).toUpperCase();
            }
          }
          
          // Cập nhật dashboard với dữ liệu thực
          updateDashboard(uid);
        }); 
      } else {
        // Chuyển hướng đến trang đăng nhập nếu chưa đăng nhập
        window.location.href = 'index.html';
      }
    });
  </script>
</body>
</html>