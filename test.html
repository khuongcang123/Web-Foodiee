<!DOCTYPE html>
<html lang="vi">
<head>
  <!-- ... (phần head giữ nguyên) ... -->
</head>
<body>
  <!-- ... (phần HTML giữ nguyên) ... -->

  <script>
    // ... (phần mã trước đó giữ nguyên) ...

    // Global variables
    let currentUser = null;
    let categories = [];
    let branches = [];
    let mainProducts = [];
    let currentImages = [];
    let uploadcareWidget = null;
    let currentEditingItem = null;
    let existingMenuItems = []; // Thêm biến để lưu trữ danh sách sản phẩm hiện có

    // ... (các hàm khác giữ nguyên) ...

    // Load menu items from Firebase
    function loadMenuItems() {
      if (!currentUser) return;
      
      database.ref(`users/${currentUser.uid}/menu`).once('value')
        .then(snapshot => {
          const data = snapshot.val();
          existingMenuItems = []; // Reset danh sách sản phẩm hiện có
          
          if (data) {
            Object.keys(data).forEach(key => {
              const item = data[key];
              item.id = key;
              existingMenuItems.push(item);
            });
          }
          
          renderMenuItems(data);
          
          // Show empty state if no items
          if (!data || Object.keys(data).length === 0) {
            emptyMenuState.style.display = 'block';
            menuList.innerHTML = '';
          } else {
            emptyMenuState.style.display = 'none';
          }
        })
        .catch(error => {
          console.error('Error loading menu items:', error);
          showToast('Lỗi khi tải dữ liệu menu', 'error');
        });
    }

    // Kiểm tra mã sản phẩm đã tồn tại
    function isCodeExists(code, excludeId = null) {
      return existingMenuItems.some(item => 
        item.code.toLowerCase() === code.toLowerCase() && 
        (!excludeId || item.id !== excludeId)
      );
    }

    // Kiểm tra tên sản phẩm đã tồn tại
    function isNameExists(name, excludeId = null) {
      return existingMenuItems.some(item => 
        item.name.toLowerCase() === name.toLowerCase() && 
        (!excludeId || item.id !== excludeId)
      );
    }

    // Hiển thị lỗi validation
    function showValidationError(inputId, message) {
      const input = document.getElementById(inputId);
      const errorDiv = document.getElementById(`${inputId}-error`);
      
      if (!errorDiv) {
        const error = document.createElement('div');
        error.id = `${inputId}-error`;
        error.className = 'error-message';
        error.style.color = 'var(--accent)';
        error.style.fontSize = '0.85rem';
        error.style.marginTop = '5px';
        error.textContent = message;
        
        input.parentNode.appendChild(error);
      } else {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      }
      
      input.style.borderColor = 'var(--accent)';
    }

    // Ẩn lỗi validation
    function hideValidationError(inputId) {
      const input = document.getElementById(inputId);
      const errorDiv = document.getElementById(`${inputId}-error`);
      
      if (errorDiv) {
        errorDiv.style.display = 'none';
      }
      
      input.style.borderColor = '';
    }

    // Kiểm tra mã sản phẩm real-time
    function checkMenuCode() {
      const code = document.getElementById('menu-code').value.trim();
      const isEditing = !!currentEditingItem;
      
      if (!code) {
        showValidationError('menu-code', 'Vui lòng nhập mã món');
        return false;
      }
      
      if (isCodeExists(code, isEditing ? currentEditingItem : null)) {
        showValidationError('menu-code', 'Mã món đã tồn tại');
        return false;
      }
      
      hideValidationError('menu-code');
      return true;
    }

    // Kiểm tra tên sản phẩm real-time
    function checkMenuName() {
      const name = document.getElementById('menu-name').value.trim();
      const isEditing = !!currentEditingItem;
      
      if (!name) {
        showValidationError('menu-name', 'Vui lòng nhập tên món');
        return false;
      }
      
      if (isNameExists(name, isEditing ? currentEditingItem : null)) {
        showValidationError('menu-name', 'Tên món đã tồn tại');
        return false;
      }
      
      hideValidationError('menu-name');
      return true;
    }

    // Open menu modal (add or edit)
    function openMenuModal(mode, itemId = null) {
      const modal = document.getElementById('menu-modal');
      const title = document.getElementById('modal-title');
      const saveBtn = document.getElementById('save-btn');
      
      if (mode === 'add') {
        title.innerHTML = '<i class="fas fa-plus"></i> Thêm món mới';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Thêm món';
        saveBtn.onclick = saveMenuItem;
        currentEditingItem = null;
      } else if (mode === 'edit') {
        title.innerHTML = '<i class="fas fa-edit"></i> Sửa món ăn';
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Cập nhật';
        saveBtn.onclick = updateMenuItem;
        loadMenuItemForEdit(itemId);
      }
      
      modal.style.display = 'flex';
      
      // Reset form
      document.getElementById('menu-code').value = '';
      document.getElementById('menu-code').disabled = (mode === 'edit');
      document.getElementById('menu-name').value = '';
      document.getElementById('menu-base-price').value = '';
      document.getElementById('menu-sale-price').value = '';
      document.getElementById('menu-description').value = '';
      document.getElementById('menu-status').value = 'active';
      document.getElementById('menu-category').selectedIndex = 0;
      document.getElementById('side-product-main').selectedIndex = 0;
      document.getElementById('product-type-main').checked = true;
      document.getElementById('side-product-options').style.display = 'none';
      
      // Xóa các thông báo lỗi cũ
      hideValidationError('menu-code');
      hideValidationError('menu-name');
      
      // Reset product type UI
      document.getElementById('main-product-option').classList.add('active');
      document.getElementById('side-product-option').classList.remove('active');
      
      // Clear images
      currentImages = [];
      updateImagePreviews();
      
      // Uncheck all branches
      const branchCheckboxes = document.querySelectorAll('#branches-selection input[type="checkbox"]');
      branchCheckboxes.forEach(branch => {
        branch.checked = false;
      });
      
      // Initialize Uploadcare widget
      if (!uploadcareWidget) {
        const widgetElement = document.getElementById('uploadcare-widget');
        uploadcareWidget = uploadcare.Widget(widgetElement);
        
        uploadcareWidget.onChange(function(file) {
          if (file) {
            file.done(function(info) {
              if (currentImages.length >= 5) {
                showToast('Bạn chỉ có thể tải lên tối đa 5 ảnh', 'warning');
                return;
              }
              
              // Check file size (1MB = 1000000 bytes)
              if (info.size > 1000000) {
                showToast('Ảnh không được vượt quá 1MB', 'error');
                return;
              }
              
              currentImages.push(info.cdnUrl);
              updateImagePreviews();
            });
          }
        });
      } else {
        uploadcareWidget.value(null);
      }
      
      // Load main products for side products
      loadMainProducts();
      
      // Add event listeners for product type
      document.getElementById('main-product-option').addEventListener('click', function() {
        document.getElementById('product-type-main').checked = true;
        document.getElementById('side-product-options').style.display = 'none';
        this.classList.add('active');
        document.getElementById('side-product-option').classList.remove('active');
      });
      
      document.getElementById('side-product-option').addEventListener('click', function() {
        document.getElementById('product-type-side').checked = true;
        document.getElementById('side-product-options').style.display = 'block';
        this.classList.add('active');
        document.getElementById('main-product-option').classList.remove('active');
      });
      
      // Thêm sự kiện kiểm tra real-time
      document.getElementById('menu-code').addEventListener('input', checkMenuCode);
      document.getElementById('menu-code').addEventListener('blur', checkMenuCode);
      document.getElementById('menu-name').addEventListener('input', checkMenuName);
      document.getElementById('menu-name').addEventListener('blur', checkMenuName);
    }

    // Save menu item to Firebase
    function saveMenuItem() {
      if (!currentUser) {
        showToast('Bạn chưa đăng nhập!', 'error');
        return;
      }
      
      // Get form values
      const code = document.getElementById('menu-code').value.trim();
      const name = document.getElementById('menu-name').value.trim();
      const categoryId = document.getElementById('menu-category').value;
      const basePrice = parseInt(document.getElementById('menu-base-price').value) || 0;
      const salePrice = parseInt(document.getElementById('menu-sale-price').value) || 0;
      const productType = document.querySelector('input[name="product-type"]:checked').value;
      const mainProductId = document.getElementById('side-product-main').value;
      const description = document.getElementById('menu-description').value.trim();
      const status = document.getElementById('menu-status').value;
      
      // Get selected branches
      const selectedBranches = [];
      document.querySelectorAll('#branches-selection input[type="checkbox"]:checked:not(#branch-all)').forEach(checkbox => {
        selectedBranches.push(checkbox.value);
      });
      
      // Validation
      if (!checkMenuCode() || !checkMenuName()) {
        showToast('Vui lòng kiểm tra lại thông tin mã và tên món', 'error');
        return;
      }
      
      if (!categoryId) {
        showToast('Vui lòng chọn danh mục', 'error');
        return;
      }
      
      if (basePrice <= 0) {
        showToast('Giá gốc phải lớn hơn 0', 'error');
        return;
      }
      
      if (salePrice > 0 && salePrice >= basePrice) {
        showToast('Giá khuyến mãi phải nhỏ hơn giá gốc', 'error');
        return;
      }
      
      if (productType === 'side' && !mainProductId) {
        showToast('Vui lòng chọn sản phẩm chính để áp dụng', 'error');
        return;
      }
      
      if (selectedBranches.length === 0) {
        showToast('Vui lòng chọn ít nhất một chi nhánh', 'error');
        return;
      }
      
      if (currentImages.length === 0) {
        showToast('Vui lòng tải lên ít nhất một ảnh', 'error');
        return;
      }
      
      // Find category name
      const category = categories.find(c => c.id === categoryId);
      const categoryName = category ? category.name : '';
      
      // Create menu item data
      const menuItem = {
        code: code,
        name: name,
        categoryId: categoryId,
        categoryName: categoryName,
        basePrice: basePrice,
        salePrice: salePrice,
        productType: productType,
        mainProductId: productType === 'side' ? mainProductId : null,
        images: currentImages,
        branches: selectedBranches,
        description: description,
        status: status,
        createdAt: new Date().toISOString()
      };
      
      // Save to Firebase
      const menuRef = database.ref(`users/${currentUser.uid}/menu/${code}`);
      menuRef.set(menuItem)
        .then(() => {
          closeMenuModal();
          loadMenuItems();
          showToast('Thêm món thành công!', 'success');
        })
        .catch(error => {
          console.error('Error saving menu item:', error);
          showToast('Có lỗi xảy ra: ' + error.message, 'error');
        });
    }

    // Update menu item
    function updateMenuItem() {
      if (!currentUser || !currentEditingItem) {
        showToast('Không có món ăn nào được chọn để sửa', 'error');
        return;
      }
      
      // Get form values
      const name = document.getElementById('menu-name').value.trim();
      const categoryId = document.getElementById('menu-category').value;
      const basePrice = parseInt(document.getElementById('menu-base-price').value) || 0;
      const salePrice = parseInt(document.getElementById('menu-sale-price').value) || 0;
      const productType = document.querySelector('input[name="product-type"]:checked').value;
      const mainProductId = document.getElementById('side-product-main').value;
      const description = document.getElementById('menu-description').value.trim();
      const status = document.getElementById('menu-status').value;
      
      // Get selected branches
      const selectedBranches = [];
      document.querySelectorAll('#branches-selection input[type="checkbox"]:checked:not(#branch-all)').forEach(checkbox => {
        selectedBranches.push(checkbox.value);
      });
      
      // Validation
      if (!checkMenuName()) {
        showToast('Vui lòng kiểm tra lại thông tin tên món', 'error');
        return;
      }
      
      if (!categoryId) {
        showToast('Vui lòng chọn danh mục', 'error');
        return;
      }
      
      if (basePrice <= 0) {
        showToast('Giá gốc phải lớn hơn 0', 'error');
        return;
      }
      
      if (salePrice > 0 && salePrice >= basePrice) {
        showToast('Giá khuyến mãi phải nhỏ hơn giá gốc', 'error');
        return;
      }
      
      if (productType === 'side' && !mainProductId) {
        showToast('Vui lòng chọn sản phẩm chính để áp dụng', 'error');
        return;
      }
      
      if (selectedBranches.length === 0) {
        showToast('Vui lòng chọn ít nhất một chi nhánh', 'error');
        return;
      }
      
      if (currentImages.length === 0) {
        showToast('Vui lòng tải lên ít nhất một ảnh', 'error');
        return;
      }
      
      // Find category name
      const category = categories.find(c => c.id === categoryId);
      const categoryName = category ? category.name : '';
      
      // Create updated menu item data
      const menuItem = {
        name: name,
        categoryId: categoryId,
        categoryName: categoryName,
        basePrice: basePrice,
        salePrice: salePrice,
        productType: productType,
        mainProductId: productType === 'side' ? mainProductId : null,
        images: currentImages,
        branches: selectedBranches,
        description: description,
        status: status
      };
      
      // Update to Firebase
      const menuRef = database.ref(`users/${currentUser.uid}/menu/${currentEditingItem}`);
      menuRef.update(menuItem)
        .then(() => {
          closeMenuModal();
          loadMenuItems();
          showToast('Cập nhật món thành công!', 'success');
        })
        .catch(error => {
          console.error('Error updating menu item:', error);
          showToast('Có lỗi xảy ra: ' + error.message, 'error');
        });
    }

    // ... (các hàm còn lại giữ nguyên) ...
  </script>
</body>
</html>